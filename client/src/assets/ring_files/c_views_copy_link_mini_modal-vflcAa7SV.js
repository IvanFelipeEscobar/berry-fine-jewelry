define(["require","exports","./e_edison","./e_ui_page_files_router","./c_share_modal_evolution_utils_logging","./c_src_utils_logging","./c_core_browser_detection","./c_core_i18n","./c_lodash-es_lodash","./c_components_sharing_spinner","./c_truncate_index","./c_clipboard_v3","./c_sharing_ui_util","metaserver/static/js/modules/constants/sharing","./c_udcl_index","./c_tslib","./e_core_exception","./c_core_exception_info"],(function(e,t,i,s,n,r,o,a,c,l,p,d,h,u,_,E,m,f){"use strict";var g,C,L,k;!function(e){e.PENDING="pending",e.COPY="copy",e.RESULT="result",e.ERROR_CLIENT="error_client",e.ERROR_SERVER="error_server"}(g||(g={})),t.CopyLinkException=void 0,(C=t.CopyLinkException||(t.CopyLinkException={})).SHARED_LINK_ALREADY_EXISTS="shared_link_already_exists",C.ACCESS_DENIED="access_denied",C.PATH="path",C.NOT_FOUND="not_found",C.EMAIL_NOT_VERIFIED="email_not_verified",C.SETTINGS_ERROR="settings_error",C.NOT_AUTHORIZED="not_authorized",C.UNDEFINED_ERROR="undefined_error",C.FAILED_COPY_TO_CLIPBOARD="failed_copy_to_clipboard",function(e){e.PENDING="pending",e.COPY="copy",e.RESULT="result",e.ERROR="error"}(L||(L={})),function(e){e.EXEC_COMMAND="exec_command",e.CLIPBOARD_API="clipboard_api",e.MANUAL="manual"}(k||(k={}));const O=e=>{switch(e){case t.CopyLinkException.ACCESS_DENIED:case t.CopyLinkException.NOT_AUTHORIZED:return a.intl.formatMessage({id:"2wQgFw",defaultMessage:"Couldn't copy the link. You don't have permission to create a link to this content."});case t.CopyLinkException.NOT_FOUND:return a.intl.formatMessage({id:"+HMjSg",defaultMessage:"We can't find this file anymore. Try checking activity or folder history to see what happened."});case t.CopyLinkException.EMAIL_NOT_VERIFIED:return a.intl.formatMessage({id:"cHWnMe",defaultMessage:"You can't share until you verify your email address."});default:return a.intl.formatMessage({id:"pAS2H5",defaultMessage:"Couldn't copy, but it might be a fluke. Try reloading the page or ask us for help."})}},v="copy-link-mini-modal__header";class I extends i.reactExports.Component{constructor(){super(...arguments),this._getContentName=e=>{if(e){const t=e.split("/");return t[t.length-1]}},this._hasFileExtension=e=>{var t;const i=null===(t=this.props.fileInfo)||void 0===t?void 0:t.is_dir;if(!e||i)return!1;return e.lastIndexOf(".")>0}}render(){return i.reactExports.createElement("div",{className:v},i.reactExports.createElement("div",{className:`${v}-content`},this.props.stageType===g.PENDING&&this._renderPendingStage(),this.props.stageType===g.COPY&&this._renderCopyStage(),this.props.stageType===g.RESULT&&this._renderResultStage(),this.props.stageType===g.ERROR_CLIENT&&this._renderClientErrorStage(),this.props.stageType===g.ERROR_SERVER&&this._renderServerErrorStage()),this._renderCloseButton())}_renderPendingStage(){return i.reactExports.createElement(i.reactExports.Fragment,null,i.reactExports.createElement(l.SharingSpinner,{ariaValue:"Loading xsmall",textSize:"standard"}),i.reactExports.createElement(s.Text,{className:`${v}--pending-text`},a.intl.formatMessage({id:"LPF3tp",defaultMessage:"Getting the link..."})))}_renderCopyStage(){return i.reactExports.createElement(s.Text,null,i.reactExports.createElement(s.Link,{href:"#",hasNoUnderline:!0,onClick:this.props.actionHandler,isBold:!0},i.reactExports.createElement(s.UIIcon,{src:s.LinkLine,"aria-label":""}),a.intl.formatMessage({id:"emiHs/",defaultMessage:"Copy Link"})))}_renderResultStage(){var e,t;const n=a.intl.formatMessage({id:"l+Mf7Y",defaultMessage:"Allows editing."}),r=a.intl.formatMessage({id:"FXqYpV",defaultMessage:"Allows viewing."});let o="";void 0!==this.props.linkAccessLevel&&(o="editor"===this.props.linkAccessLevel?n:r);const c=this._getContentName(null===(e=this.props.fileInfo)||void 0===e?void 0:e.fq_path),l=this._hasFileExtension(null===(t=this.props.fileInfo)||void 0===t?void 0:t.fq_path),d=c?i.reactExports.createElement(p.Truncate,{className:`${v}--content-name`,maxWidth:225,observeParent:!0,location:.5},c):void 0,h=d?l?a.intl.formatMessage({id:"0KPHns",defaultMessage:'Link copied to "{contentNameInHeader}".'},{contentNameInHeader:d}):a.intl.formatMessage({id:"Az3hZK",defaultMessage:'Link copied to "{contentNameInHeader}."'},{contentNameInHeader:d}):a.intl.formatMessage({id:"v2yJMn",defaultMessage:"Link copied."});return i.reactExports.createElement(i.reactExports.Fragment,null,i.reactExports.createElement(s.UIIcon,{className:`${v}--result-icon`,src:s.CheckmarkCircleLine,size:"standard","aria-label":""}),i.reactExports.createElement("div",{className:`${v}--result-container`},i.reactExports.createElement(s.Text,{className:`${v}--result-text`,isBold:!0},h," "),i.reactExports.createElement(s.Text,null,o)))}_renderClientErrorStage(){return i.reactExports.createElement(i.reactExports.Fragment,null,i.reactExports.createElement(s.UIIcon,{className:`${v}--client-error-icon`,src:s.FailLine,"aria-label":""}),i.reactExports.createElement(s.Text,{className:`${v}--client-error-text`},i.reactExports.createElement("b",null,a.intl.formatMessage({id:"rp1Lxc",defaultMessage:"Couldn't copy the link."})," "),i.reactExports.createElement(s.Link,{href:"#",hasNoUnderline:!0,onClick:this.props.actionHandler,isBold:!0},a.intl.formatMessage({id:"wXhxJC",defaultMessage:"Try again"}))))}_renderServerErrorStage(){return i.reactExports.createElement(i.reactExports.Fragment,null,i.reactExports.createElement("div",null,i.reactExports.createElement(s.UIIcon,{size:"standard",src:s.FailLine,"aria-label":""})),i.reactExports.createElement(s.Text,{className:`${v}--server-error-text`},this.props.errorMessage))}_renderCloseButton(){return i.reactExports.createElement(s.IconButton,{"aria-label":"close",onClick:this.props.closeButtonHandler,variant:"transparent",isRounded:!0,size:"small"},i.reactExports.createElement(s.UIIcon,{src:s.CloseLine,"aria-label":""}))}}I.displayName="CopyLinkMiniModalHeaderComponent";const R=s.requireCssWithComponent(I,["/static/metaserver/static/css/dig-components/index.web-vflGcQt8W.css","/static/metaserver/static/css/sharing/copy_link_mini_modal-vfl9Z9lUi.css"]);class y extends i.reactExports.Component{constructor(){super(...arguments),this.handleCopy=()=>{this.props.onCopyToClipboard(k.MANUAL)}}componentDidMount(){this.props.shouldFocusOnLink&&this.props.focusOnInput()}componentDidUpdate(){this.props.shouldFocusOnLink&&this.props.focusOnInput()}render(){return i.reactExports.createElement("div",{className:"copy-link-mini-modal__link"},i.reactExports.createElement(s.TextInput,{onCopy:this.handleCopy,size:"standard","aria-label":"Link for copy link click",value:this.props.sharedLink.url,readOnly:!0,onClick:this.props.focusOnInput,ref:this.props.inputRef}))}}y.displayName="CopyLinkMiniModalLinkComponent";const T=s.requireCssWithComponent(y,["/static/metaserver/static/css/dig-components/index.web-vflGcQt8W.css","/static/metaserver/static/css/sharing/copy_link_mini_modal-vfl9Z9lUi.css"]);class x extends i.React$1.Component{constructor(){super(...arguments),this.onWindowResize=c.throttle((()=>{this.props.anchorRef.current||this.props.closeButtonHandler()}),500),this.handleClick=e=>{e.preventDefault(),e.stopPropagation()}}componentDidMount(){window.addEventListener("resize",this.onWindowResize)}componentWillUnmount(){window.removeEventListener("resize",this.onWindowResize)}render(){var e;const{anchorRef:t,inputRef:n,stage:r,closeButtonHandler:o,linkAccessLevel:a,sharedLink:c,shouldFocusOnLink:l,focusOnInput:p,actionHandler:d,errorMessage:h,onCopyToClipboard:u,zIndexOverride:_,placement:E,fileInfo:m}=this.props,f=i.React$1.createElement(R,{stageType:r,actionHandler:d,closeButtonHandler:o,sharedLink:c,linkAccessLevel:a,errorMessage:h,fileInfo:m});let g=i.React$1.createElement(i.React$1.Fragment,null);return c&&p&&n&&(g=i.React$1.createElement(T,{sharedLink:c,focusOnInput:p,inputRef:n,shouldFocusOnLink:l,onCopyToClipboard:u})),i.React$1.createElement(s.LayerContext.Provider,{value:{zIndex:_||20}},i.React$1.createElement(s.ClickOutside,{isActive:!0,onClickOutside:o,shouldPropagateMouseEvents:!1,isBlock:!0,shouldClickOutsideWhenDefaultPrevented:!0},i.React$1.createElement(s.Overlay,{className:"copy-link-mini-modal__overlay",anchorRef:t,placement:E||"bottom",auto:!0,offsetDistance:null!==(e=this.props.yOffsetDistance)&&void 0!==e?e:4,onClick:this.handleClick},f,g)))}}x.displayName="CopyLinkMiniModalOverlayComponent";const N=s.requireCssWithComponent(x,["/static/metaserver/static/css/sharing/copy_link_mini_modal-vfl9Z9lUi.css","/static/metaserver/static/css/dig-components/index.web-vflGcQt8W.css"]),S="udcl_web_client_tracing";function A(e){return{class:"share",action:"create",object:"shared_link",properties:e}}const b=["max","editor","viewer"];function D(e){return b.find((t=>t===(null==e?void 0:e.toLowerCase())))}!function(){var t,i,s,n,r,o;E.__awaiter(this,void 0,void 0,(function*(){try{const{getActiveUserId:a}=yield new Promise((function(t,i){e(["./e_ui_page_files_router"],t,i)})).then((function(e){return e.active_user_esnext})),{getVariantInfos:c,logExposure:l}=yield new Promise((function(t,i){e(["./e_ui_page_files_router"],t,i)})).then((function(e){return e.explicit_exposure_logging_esnext})),p=yield c([S],a()),d=null==p?void 0:p[0],h="ON"===(null==d?void 0:d.variant),u=null!==(s=null===(i=null===(t=null==d?void 0:d.metadata)||void 0===t?void 0:t.metadata)||void 0===i?void 0:i.population_id)&&void 0!==s?s:"",_=null!==(o=null===(r=null===(n=null==d?void 0:d.metadata)||void 0===n?void 0:n.metadata)||void 0===r?void 0:r.identity_gid)&&void 0!==o?o:"",E={stormcrowVariantInfo:{feature:S,variant:null==d?void 0:d.variant,metadata:{metadata:{population_id:u,identity_gid:_}}}};if(h){l(E.stormcrowVariantInfo);const{tracer:t}=yield new Promise((function(t,i){e(["./c_tracing_tracer"],t,i)}));return{default:t}}}catch(e){m.reportException({err:e,severity:f.SEVERITY.NONCRITICAL})}return{default:{}}}))}();class M extends i.React$1.Component{constructor(e){super(e),this.handleCopyLinkToClipboard=()=>{d.copyToClipboard(this.sharedLink.url,(()=>{this.handleClipboardSuccess(k.EXEC_COMMAND)}),this.handleClipboardFailure)},this.handleClipboardSuccess=e=>{e!==k.MANUAL&&this.setState({stage:L.RESULT}),this.logEvent(r.TiburonEventName.CopySharedLink,{created_new_link:this.isLinkNewlyCreated,copy_method:e,access:this.getAccessLevel(),timing:this.getLinkActionTTI(this.startCopyLinkTime)})},this.handleClipboardFailure=()=>{this.copyLinkToClipboardNewAPI()},this.copyLinkToClipboardNewAPI=()=>{if(navigator.clipboard){const e=this.sharedLink.url;navigator.clipboard.writeText(e).then((()=>{this.handleClipboardSuccess(k.CLIPBOARD_API)}),(()=>{this.handleClipboardFailureNewAPI()}))}else this.handleClipboardFailureNewAPI()},this.handleClipboardFailureNewAPI=()=>{this.exceptionType=t.CopyLinkException.FAILED_COPY_TO_CLIPBOARD,this.failToFetchCopyLinkHelper()},this.getLinkActionTTI=e=>Date.now()-e,this.onClose=()=>{this.props.setIsCreatingSharedLink(!1,this.fileIdOrPath),this.props.userActionSource===s.ActionSourceValue.BUTTON&&this.props.onHoverLocked&&this.props.onHoverLocked({isOpen:!1}),this.props.onActionFlowComplete&&this.props.onActionFlowComplete(),this.setState({isOpen:!1})},this.focusOnInput=()=>{this.inputRef.current&&this.inputRef.current.select()},this.inputRef=i.React$1.createRef(),this.state={isOpen:!0,stage:L.PENDING},this.fileIdOrPath=this.getFileIdOrPath()}componentDidMount(){var e;_.mark(`create-shared-link-${this.fileIdOrPath}`),s.logEvent(A({eventState:"start",sharedLinkRequestedAccessLevel:D(this.getAccessLevel()),isDir:null===(e=this.props.file)||void 0===e?void 0:e.is_dir})),this.createSharedLink()}createSharedLink(){this.props.setIsCreatingSharedLink(!0,this.fileIdOrPath),this.props.userActionSource===s.ActionSourceValue.BUTTON&&this.props.onHoverLocked&&this.props.onHoverLocked({isOpen:!0}),this.startCreateLinkTime=Date.now();const e=(i=this.props.user,new s.FileShareApiClient({userId:i.id}));var i;let n=this.props.isInUserLevelSharingSettings?"default":"max";n="ON"===u.SHARING_EXPERIMENTS.USER_LEVEL_SHARING_SETTINGS?"default":n,e.createSharedLinkNonAlpha({fileIdOrPath:this.fileIdOrPath,settings:{access:n}}).then((e=>{this.startCopyLinkTime=Date.now(),this.succeedToFetchLinkHelper(e,!0),this.logEvent(r.TiburonEventName.AttemptCreateSharedLinkWithSettings,{access:this.getAccessLevel()})})).catch((e=>{this.startCopyLinkTime=Date.now(),e.error[".tag"]===t.CopyLinkException.SHARED_LINK_ALREADY_EXISTS?this.succeedToFetchLinkHelper(e.error.shared_link_already_exists.metadata,!1,e):e.error[".tag"]===t.CopyLinkException.ACCESS_DENIED?(this.exceptionType=t.CopyLinkException.ACCESS_DENIED,this.failToFetchCopyLinkHelper(e)):e.error[".tag"]===t.CopyLinkException.SETTINGS_ERROR&&e.error.settings_error[".tag"]===t.CopyLinkException.NOT_AUTHORIZED?(this.exceptionType=t.CopyLinkException.NOT_AUTHORIZED,this.failToFetchCopyLinkHelper(e)):e.error[".tag"]===t.CopyLinkException.PATH&&e.error.path[".tag"]===t.CopyLinkException.NOT_FOUND?(this.exceptionType=t.CopyLinkException.NOT_FOUND,this.failToFetchCopyLinkHelper(e)):e.error[".tag"]===t.CopyLinkException.EMAIL_NOT_VERIFIED?(this.exceptionType=t.CopyLinkException.EMAIL_NOT_VERIFIED,this.failToFetchCopyLinkHelper(e)):(this.exceptionType=e.error[".tag"]?e.error[".tag"]:t.CopyLinkException.UNDEFINED_ERROR,this.failToFetchCopyLinkHelper(e)),this.logEvent(r.TiburonEventName.AttemptCreateSharedLinkWithSettings,{access:n,timing:this.getLinkActionTTI(this.startCopyLinkTime)})}))}succeedToFetchLinkHelper(e,t,i){var n;this.sharedLink=e,this.isLinkNewlyCreated=t;const o=t?200:i&&i.raw&&i.raw.status;this.logEvent(r.TiburonEventName.SucceedCreateSharedLinkWithSettings,{created_new_link:t,http_status_code:o,response_status:"success",is_alpha:!1,access:this.getAccessLevel(),timing:this.getLinkActionTTI(this.startCreateLinkTime)}),t&&this.props.file&&s.getStoreForSharedWith().dispatch(s.sharedLinkDataOutOfDate(this.props.file.fq_path)),(()=>{const e=document.createElement("input");return e.value="sharing is caring",document.body.appendChild(e),e.select(),document.queryCommandEnabled("copy")})()?this.handleCopyLinkToClipboard():this.setState({stage:L.COPY});const a=_.measure("tts",{start:`create-shared-link-${this.fileIdOrPath}`,end:performance.now(),detail:{jtbd:"create_shared_link"}});s.logEvent(A({eventState:"success",sharedLinkRequestedAccessLevel:D(this.getAccessLevel()),isDir:null===(n=this.props.file)||void 0===n?void 0:n.is_dir,udclMeasureId:a}))}failToFetchCopyLinkHelper(e){e&&this.logEvent(r.TiburonEventName.FailCreateSharedLinkWithSettings,{error_message:this.exceptionType,http_status_code:e.raw&&e.raw.status,is_alpha:!1,timing:this.getLinkActionTTI(this.startCreateLinkTime)}),this.setState({stage:L.ERROR}),this.logEvent(r.TiburonEventName.CopySharedLinkFailure,{error:this.exceptionType,timing:this.getLinkActionTTI(this.startCopyLinkTime)}),_.measure("ttf",{start:`create-shared-link-${this.fileIdOrPath}`,end:performance.now(),detail:{jtbd:"create_shared_link"}})}getFileIdOrPath(){var e,t;return(null===(e=this.props.file)||void 0===e?void 0:e.file_id)||(null===(t=this.props.file)||void 0===t?void 0:t.fq_path)||this.props.filePath}getAccessLevel(){const e=this.sharedLink?this.sharedLink.link_permissions.link_access_level:void 0;let t="viewer";return e&&(t=e.hasOwnProperty(".tag")?e[".tag"]:e),t}logEvent(e,t){var i,a;let c=s.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_ROW_BUTTON;this.props.userActionSurfaceLogValue===s.ActionSurfaceLogValue.RIGHT_SIDEBAR?(c=s.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_ACTIONS,t=this.props.rightRailCollapsed?Object.assign(Object.assign({},t),{source:"right_rail_collapsed"}):Object.assign(Object.assign({},t),{source:"right_rail_open"})):this.props.userActionSource===s.ActionSourceValue.OVERFLOW_MENU?c=s.SHARE_ACTION_ORIGIN_TYPE.BROWSE_FILE_ROW_OVERFLOW_MENU:this.props.userActionSource===s.ActionSourceValue.COPY_LINK_FROM_UPLOAD_MODAL&&(c=s.SHARE_ACTION_ORIGIN_TYPE.COPY_LINK_FROM_UPLOAD_MODAL);const l=o.get_browser_info();s.ShareTibEventLogger.log(this.props.user.id,e,c,Object.assign(Object.assign(Object.assign({},n.buildExtraFromLinkMetadata(this.sharedLink)),{file_id:null===(i=this.props.file)||void 0===i?void 0:i.file_id,fq_path:(null===(a=this.props.file)||void 0===a?void 0:a.fq_path)||this.props.filePath,browser:l.browser,browser_version:l.version}),t)),e===r.TiburonEventName.CopySharedLink&&h.trackUserLeapEvent(h.SharingUserLeapEvent.SHARE_LINK_COPY_SUCCESS,c)}static show(e,t){s.Modal.showInstance(i.React$1.createElement(P,Object.assign({},e)),!0,t)}render(){if(!this.state.isOpen)return null;switch(this.state.stage){case L.PENDING:return i.React$1.createElement(N,{stage:g.PENDING,closeButtonHandler:this.onClose,anchorRef:this.props.anchorRef,zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement});case L.COPY:return i.React$1.createElement(N,{stage:g.COPY,actionHandler:this.handleCopyLinkToClipboard,closeButtonHandler:this.onClose,sharedLink:this.sharedLink,focusOnInput:this.focusOnInput,anchorRef:this.props.anchorRef,inputRef:this.inputRef,shouldFocusOnLink:!1,onCopyToClipboard:this.handleClipboardSuccess,zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement});case L.ERROR:return this.exceptionType!==t.CopyLinkException.FAILED_COPY_TO_CLIPBOARD?i.React$1.createElement(N,{stage:g.ERROR_SERVER,closeButtonHandler:this.onClose,anchorRef:this.props.anchorRef,errorMessage:O(this.exceptionType),zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement}):i.React$1.createElement(N,{stage:g.ERROR_CLIENT,actionHandler:this.handleCopyLinkToClipboard,closeButtonHandler:this.onClose,sharedLink:this.sharedLink,focusOnInput:this.focusOnInput,inputRef:this.inputRef,anchorRef:this.props.anchorRef,shouldFocusOnLink:!0,onCopyToClipboard:this.handleClipboardSuccess,zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement});case L.RESULT:return i.React$1.createElement(N,{stage:g.RESULT,linkAccessLevel:this.getAccessLevel(),actionHandler:this.handleCopyLinkToClipboard,closeButtonHandler:this.onClose,sharedLink:this.sharedLink,focusOnInput:this.focusOnInput,inputRef:this.inputRef,anchorRef:this.props.anchorRef,shouldFocusOnLink:!0,onCopyToClipboard:this.handleClipboardSuccess,zIndexOverride:this.props.zIndexOverride,yOffsetDistance:this.props.yOffsetDistance,placement:this.props.placement,fileInfo:this.props.file})}}}M.displayName="CopyLinkMiniModalComponent";const P=s.requireCssWithComponent(M,["/static/metaserver/static/css/sharing/copy_link_mini_modal-vfl9Z9lUi.css","/static/metaserver/static/css/dig-components/index.web-vflGcQt8W.css"]);t.CopyLinkMiniModal=P}));
//# sourceMappingURL=c_views_copy_link_mini_modal.js-vflRWHDGQ.map
