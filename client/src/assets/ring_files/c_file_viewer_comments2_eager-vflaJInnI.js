define(["require","exports","./c_tslib","./e_edison","./e_ui_page_files_router","./c_comments_data_store","./c_components_approval-forms_gating_utils","./c_components_approval-forms_url_utils","./c_components_approval-forms_approval_checkbox_in_share","./c_core_i18n","./c_core_types_preview_type","./c_file_viewer_ui_header2","./c_core_data_utils","./c_core_logging_constants","./c_file_viewer_file_viewer_components","./c_file_viewer_video_controls_audio_video_markers","./c_api_v2_redux_files","./c_file_viewer_sdk_file_viewer_file_viewer"],(function(e,t,a,i,n,r,o,s,l,d,c,m,h,u,_,g,p,f){"use strict";const v=d.defineMessage({id:"IKrBL8",defaultMessage:"Highlight a section to comment on"}),I=d.defineMessage({id:"Dm5bk9",defaultMessage:"Highlight an area to comment on"}),y=d.defineMessage({id:"VYvI4T",defaultMessage:"Using the arrow keys, select an area to comment on, then hit enter."}),R=d.defineMessage({id:"gO661I",defaultMessage:"Enable continuous commenting?"}),C=d.defineMessage({id:"pCmwyu",defaultMessage:"Now, add your comment in the comments pane"}),A=d.defineMessage({id:"8UKHBA",defaultMessage:"Using the arrow keys, select a timestamp to comment on, then hit enter"}),b=d.defineMessage({id:"DeTJfa",defaultMessage:"Add your comment in the comments pane"}),w=d.defineMessage({id:"55kTfU",defaultMessage:"Cancel"}),M=d.defineMessage({id:"+Guzmf",defaultMessage:"Enable"}),T=i.reactExports.memo((({fileViewerId:e,previewType:t})=>{const a=n.useSelector((e=>e.annotationSettings.state)),o=n.useDispatch(),s=d.useIntl(),[l,h]=r.useContinuousAnnotation(),u=n.useSelector(r.isSingularlyAnnotating),_=l||"annotating"!==a?()=>{o(r.cancelAnnotating(e))}:()=>{o(r.updateAnnotationMode(r.SectionAnnotationMode.continuous)),h()};let g,p,f=s.formatMessage(w);if(t===c.PreviewType.Audio||t===c.PreviewType.Video)if("commenting"===a)g=s.formatMessage(b);else{if("annotating-ax"!==a)return null;g=s.formatMessage(A)}else if(!l&&u&&"annotating"===a)g=s.formatMessage(R),f=s.formatMessage(M),p=s.formatMessage({id:"LwqLT7",defaultMessage:"Close"});else if("annotating"===a)g=t===c.PreviewType.Image?s.formatMessage(I):s.formatMessage(v);else if("annotating-ax"===a)g=s.formatMessage(y);else{if("commenting"!==a)return null;g=s.formatMessage(C)}return i.reactExports.createElement("div",{className:m.floatingHeader},i.reactExports.createElement(n.Banner,{type:"attention",withLeftIcon:!1,onRequestClose:()=>{h()},withCloseButton:p},i.reactExports.createElement(n.Banner.Message,null,g),i.reactExports.createElement(n.Banner.Actions,null,i.reactExports.createElement(n.Button$1,{variant:"transparent",onClick:_},f))))}));T.displayName="AnnotationBanner",T.displayName="AnnotationBanner";function E({event:e,stream:t,thread_id:a,comment_id:i,is_third_party:n,error:o}){return r.logEventAction({arg:{event:o?{".tag":"comment_error"}:e,stream:t,thread_id:a,comment_id:i,is_third_party:n,oref:"dfv",product_surface:{".tag":"file_preview"},product_surface_context:{".tag":"file_preview"},error_message:o?o.message:void 0}})}const x=({dispatch:e})=>t=>a=>{const i=t(a);if(a.type===r.Action.AddCommentResult)e(E({event:a.payload.arg.thread_id?{".tag":"reply_to_comment"}:{".tag":"new_comment"},stream:a.payload.arg.stream,thread_id:a.payload.arg.thread_id,error:a.error}));else if(a.type===r.Action.MarkThreadReadResult)e(E({event:{".tag":"mark_thread_as_read"},stream:a.payload.arg.stream,thread_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.MarkThreadUnreadResult)e(E({event:{".tag":"mark_thread_as_unread"},stream:a.payload.arg.stream,thread_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.ResolveThreadResult)e(E({event:{".tag":"resolve_thread"},stream:a.payload.arg.stream,thread_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.UnresolveThreadResult)e(E({event:{".tag":"unresolve_thread"},stream:a.payload.arg.stream,thread_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.DeleteCommentResult)e(E({event:{".tag":"delete_comment"},stream:a.payload.arg.stream,thread_id:a.meta?a.meta.threadId:void 0,comment_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action.EditCommentResult)e(E({event:{".tag":"edit_comment"},stream:a.payload.arg.stream,thread_id:a.meta?a.meta.threadId:void 0,comment_id:a.payload.arg.id,error:a.error}));else if(a.type===r.Action$1.ActivateThread){const{fileId:t,isThirdParty:i,threadId:n}=a.payload,o=r.createStreamFromFileId(t);e(E({event:{".tag":"activate_thread"},stream:o,thread_id:n,is_third_party:i}))}return i},P=({file:e,duration:t,fileViewerId:a,onScrubberThumbnailsLoaded:o,onHoverScrubberThumbnails:s,audioVideoMetadata:l,showInverse:d,isRedesign2023:c})=>{const m=r.createCommentFileIdentifier(e.file_id,e.url),h=n.useDispatch(),u=n.useSelector((e=>e.threads[m]||{})),p=_.useStabilizedCallback((t=>{h(r.activateThread({fileId:e.file_id,fileViewerId:a,isThirdParty:t.isThirdParty,threadId:t.id}))})),f="video"===(null==l?void 0:l[".tag"])?null==l?void 0:l.thumb_scrubber_vtt_url:void 0;return i.React$1.createElement(g.AudioVideoMarkersComponent,{threads:u,vttUrl:f,onScrubberThumbnailsLoaded:o,onHoverScrubberThumbnails:s,duration:t,openThreadInRightRail:p,showInverse:d,isRedesign2023:c})};P.displayName="CommentMarkersComponent";const $=e=>{var{container:t}=e,n=a.__rest(e,["container"]);return i.reactDomExports.createPortal(i.React$1.createElement(P,Object.assign({},n)),t)};$.displayName="CommentMarkers",$.displayName="CommentMarkers";n.injectInternalStyle("js/file_viewer/comments2/comments2.module.out.css",(e=>"._comments-pane_15725_1>.sc-comment-stream{width:100%}._contentBoxReset_15725_5 *,._contentBoxReset_15725_5 :after,._contentBoxReset_15725_5 :before{box-sizing:content-box}._comments-pane-blade_15725_11{height:100%}._disabled-annotations-show-more_15725_15{color:var(--color__attention__text);cursor:pointer}._annotation-tooltip-container_15725_20{height:25px;position:absolute;width:30px}._iconContainer_15725_26{display:flex;position:relative}._unreadBadge_15725_31{color:var(--dig-color__primary__on-base);position:absolute;right:-3px;top:-4px}"));const S=({fileId:e,sharedLinkURL:t})=>{const a=r.useUnreadCount(r.createCommentFileIdentifier(e,t));return i.React$1.createElement("span",{className:"_iconContainer_15725_26"},i.React$1.createElement(n.UIIcon,{src:n.CommentLine}),a>0&&i.React$1.createElement(n.NotificationBadge,{status:"attention",className:"_unreadBadge_15725_31"},a))};S.displayName="CommentIconWithUnreadCount";const L={showApproval:!0},k=i.React$1.lazy((()=>a.__awaiter(void 0,void 0,void 0,(function*(){const{CommentsPluginPane:t}=yield new Promise((function(t,a){e(["./c_file_viewer_comments2_pane"],t,a)}));return{default:t}}))));k.displayName="LazyCommentsPluginPane";const U=i.React$1.lazy((()=>a.__awaiter(void 0,void 0,void 0,(function*(){const{AnnotationLayer:t}=yield new Promise((function(t,a){e(["./c_comments2_annotations_annotation_layer"],t,a)}));return{default:t}}))));U.displayName="LazyAnnotationLayer";const N=()=>i.React$1.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"}},i.React$1.createElement(n.Spinner,{className:"comments-blade-loading-spinner",size:"standard"}));N.displayName="LoadingIndicator";const O=e=>i.React$1.createElement(i.React$1.Suspense,{fallback:i.React$1.createElement(N,null)},i.React$1.createElement(k,Object.assign({},e)));O.displayName="AsyncCommentsPluginPane";const B=e=>i.React$1.createElement(i.React$1.Suspense,{fallback:i.React$1.createElement(i.React$1.Fragment,null,e.children)},i.React$1.createElement(U,Object.assign({},e)));B.displayName="AsyncAnnotationLayer";class D{constructor(e,t,s={},l,d){this.didRequestfocus=!1,this.didRequestActivateThread=!1,this.loadMediaFeatures=()=>a.__awaiter(this,void 0,void 0,(function*(){const e=void 0;try{const t=yield this.platform.apiv2ClientBase.ns("media_addon").rpc("get_features",e,{});this.store.dispatch(r.getFeaturesResultAction({result:t,arg:e}));const a=t.frame_precise_comments;null!=a&&this.context.getPluginData().navigation.toggleVideoFrameSteppers(a)}catch(t){this.store.dispatch(r.getFeaturesResultAction({arg:e},null,t))}})),this.handleCancelAnnotating=()=>{this.store.getState().annotationSettings.state&&this.store.dispatch(r.cancelAnnotating(this.context.fileViewerId))},this.renderCommentsContent=e=>{const{expandedBlade:t}=i.React$1.useContext(p.RightRailContext);return _.useRecordPreviewsTimerOnMount(this.context.fileViewerId,u.PreviewsTimer.SidebarContentsMount,{bladeId:h.COMMENTS_PLUGIN_ID},t===h.COMMENTS_PLUGIN_ID),f.isSupportedPreviewType$1(e.file)?i.React$1.createElement(i.React$1.Fragment,null,i.React$1.createElement(_.KeyboardBindingConnector,{name:"comment_plugin",keyboardBindings:this.keybinding}),i.React$1.createElement(O,Object.assign({user:this.user,intl:this.platform.intl,context:this.context,config:this.config,approvalIOClient:this.approvalIOClient},e))):null},this.layerUI={LayerWithEventBubbling:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(B,Object.assign({platform:this.platform,context:this.context,config:this.config},e)))},this.rightRailUI={Control:e=>{var t;return e.file&&f.isSupportedPreviewType$1(e.file)?i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(r.CollapsedCommentsBladeButton,{id:h.COMMENTS_PLUGIN_ID,intl:this.platform.intl,fileId:null===(t=e.file)||void 0===t?void 0:t.fileId,sharedLinkURL:e.file.url})):null},Sidebar:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(r.CommentsBlade,{id:h.COMMENTS_PLUGIN_ID,intl:this.platform.intl,fileId:e.file.fileId,sharedLinkURL:e.file.url,approvalIOClient:this.approvalIOClient},this.renderCommentsContent(e)))},this.commentUI={Header:()=>{const e=this.context.getPluginData().previewType;return i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(T,{fileViewerId:this.context.fileViewerId,previewType:e}))},VideoSeekBarLayer:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement($,Object.assign({},e))),CommentIconWithUnreadCount:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(S,{fileId:e.fileId,sharedLinkURL:e.sharedLinkURL})),mediaScrubber:{onClickOutsideMarkers:()=>{this.store.dispatch(r.deactivateAllThreads({fileViewerId:this.context.fileViewerId}))}}},this.sidebarUI={Icon:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(S,{fileId:e.file.fileId,sharedLinkURL:e.file.url})),Title:()=>i.React$1.createElement(i.React$1.Fragment,null,this.platform.intl.formatMessage({id:"extqcT",defaultMessage:"Comments"})),TitleAccessory:e=>i.React$1.createElement(n.Provider,{store:this.store},i.React$1.createElement(r.CommentsMeatball,{fileId:e.file.fileId,sharedLinkURL:e.file.url,size:"standard",approvalIOClient:this.approvalIOClient})),Content:e=>i.React$1.createElement(n.Provider,{store:this.store},this.renderCommentsContent(e))},this.fetchInitialComments=(e,t)=>{const a=e.url||(null==t?void 0:t.url)||void 0;if(a){const e={include_permissions:!0,stream:{identifier:{".tag":"shared_link_details",url:a},type:{".tag":"file"}}};this.user?this.store.dispatch(r.listCommentsAction({arg:e})):this.store.dispatch(r.loggedOutListCommentsAction({arg:e}))}else this.store.dispatch(r.listCommentsAction({arg:{include_permissions:!0,stream:{identifier:{".tag":"file_path_or_id",file_path_or_id:e.fileId},type:{".tag":"file"}}}}))},this.lifecycle={previewDidInitialize:({threadId:e,shouldFocusApproval:t,shouldFocusComment:a,commentId:i})=>{var n,s;const l=this.context.getPluginData(),{file:d,sharedLinkInfo:c}=l;if(null!=d){if(this.fetchInitialComments(d,c),"string"!=typeof e||this.didRequestActivateThread){if("string"==typeof i&&!this.didRequestActivateThread){l.navigation.openRightRail(u.UserActionContext.RightRail);const e=d.url||d.fileId,t=Object.values(null!==(n=this.store.getState().threads[e])&&void 0!==n?n:{}).filter((e=>!!e)),a=r.findCommentThread(t,i);a&&this.store.dispatch(r.activateThread({fileId:d.fileId,sharedLinkURL:d.url,fileViewerId:this.context.fileViewerId,threadId:a.thread.id,isThirdParty:a.thread.isThirdParty})),this.didRequestActivateThread=!0}}else l.navigation.openRightRail(u.UserActionContext.RightRail),this.store.dispatch(r.activateInitialThread({fileViewerId:this.context.fileViewerId,threadId:e,fileId:d.fileId})),this.didRequestActivateThread=!0;if(t&&this.store.dispatch(o.setApprovalForm({[d.fileId]:{activeForm:"request",threadId:void 0}})),"string"==typeof i){const e=d.url||d.fileId,t=Object.values(null!==(s=this.store.getState().threads[e])&&void 0!==s?s:{}).filter((e=>!!e)),a=r.findCommentThread(t,i);if(a){const t=r.findActionableApprovalCommentId(a.thread),i=a.thread.comments.find((({id:e})=>e===t));i&&r.canRespondToApproval(i)&&this.store.dispatch(o.setApprovalForm({[e]:{activeForm:"respond",threadId:a.thread.id}}))}}a&&!this.didRequestfocus&&(l.navigation.openRightRail(u.UserActionContext.RightRail),l.navigation.openRightSidebarPlugin(h.COMMENTS_PLUGIN_ID,u.UserActionContext.Sidebar),this.store.dispatch(r.focusEditor(this.context.fileViewerId)),this.didRequestfocus=!0)}},previewWillTeardown:()=>{null!=this.store.getState().annotationSettings.state&&this.store.dispatch(r.cancelAnnotating(this.context.fileViewerId))}};const c=(e=>({getState:t,dispatch:a})=>i=>n=>{var o;switch(i(n),n.type){case r.Action$1.ResolveNavigationToActiveThreadAnnotation:return;case r.Action$1.ActivateInitialThread:case r.Action$1.ActivateThread:case r.Action.ListCommentsResult:{const i=t();for(const t of Object.getOwnPropertyNames(i.pendingNavigationToActiveThreadAnnotation)){if(t===e.fileViewerId){const{file:n,navigation:s}=e.getPluginData();if(null!=n){const e=r.createCommentFileIdentifier(n.fileId,n.url),l=i.activeThreadID[t],d=null===(o=i.threads[e])||void 0===o?void 0:o[l];if(d&&d.annotation){const e=d.annotation;"document"===e.type&&"navigateToPage"in s&&s.navigateToPage((e.regions[0].page||1)-1,u.UserActionContext.RightRail),"audio"!==e.type&&"video"!==e.type||!("seek"in s)||s.seek(e.time),s.openRightSidebarPlugin(h.COMMENTS_PLUGIN_ID,u.UserActionContext.SurfaceGesture),a(r.resolveNavigationToActiveThreadAnnotation(t))}}}return}return}case r.Action$1.ConfirmDraftAnnotation:{const{navigation:t}=e.getPluginData();return void t.openRightSidebarPlugin(h.COMMENTS_PLUGIN_ID,u.UserActionContext.SurfaceGesture)}}})(t);this.store=r.makeStore({apiv2ClientBase:e.apiv2ClientBase,boltIOClient:l.boltIOClient,mentionsIOClient:l.mentionsIOClient,logger:e=>{t.logUserAction(e.event,"right_sidebar",e.extra)}},[c,x]),this.platform=e,this.context=t,this.config=Object.assign(Object.assign({},L),s),this.approvalIOClient=l.approvalIOClient,this.keybinding=[_.getKeyboardBinding({key:n.Key_enum.Key.Escape,callback:this.handleCancelAnnotating})],this.user=d,this.loadMediaFeatures(),this.store.dispatch(r.getStickersAction({arg:void 0}))}}var V=Object.freeze({__proto__:null,makeLoader:function(e,t,i={}){return{pluginId:h.COMMENTS_PLUGIN_ID,load:(n,r)=>a.__awaiter(this,void 0,void 0,(function*(){return new D(n,r,i,e,t)}))}}});t.commentsPaneBlade="_comments-pane-blade_15725_11",t.contentBoxReset="_contentBoxReset_15725_5",t.disabledAnnotationsShowMore="_disabled-annotations-show-more_15725_15",t.eager_esnext=V}));
//# sourceMappingURL=c_file_viewer_comments2_eager.js-vfl2v2A-M.map
