define(["exports","./e_ui_page_files_router","./c_file_uploader_utils","./c_file_uploader_types","./c_file_uploader_result_type","./c_udcl_index","metaserver/static/js/modules/constants/global_file_upload","metaserver/static/js/modules/constants/web_experience_constants","./e_core_exception","./c_core_exception_info"],(function(e,o,t,r,s,n,a,i,_,l){"use strict";const d=new class{constructor(){this.errorCount=0,this.lastError=Date.now(),this.shouldReport=!0}log(e,r,a){if(a=Object.assign(Object.assign(Object.assign({},a),a.extra),{extra:void 0}),n.track(r,{detail:a}),this.shouldReport&&(this.errorCount<10||Date.now()-this.lastError>6e4)){const n=()=>new Promise(((t,n)=>{o.SilentBackgroundRequest$1({url:"/log/web_upload_action",data:{_subject_uid:e,event_type:r,extra_params:JSON.stringify(a)},error:e=>{if(0===e.status)return t(s.error(e,e.status,{isRetriable:!0,maxRetries:1/0}));429===e.status?this.errorCount=10:this.errorCount++,this.lastError=Date.now(),t(s.error(e,e.status,{isRetriable:429!==e.status,maxRetries:4}))},success:e=>{try{const o=JSON.parse(e);return o&&!o.continue_sending&&(this.shouldReport=!1),this.errorCount=0,t(s.ok(o))}catch(e){throw this.errorCount++,this.lastError=Date.now(),t(s.error(e,0,{isRetriable:!0,maxRetries:4})),e}}})}));return t.newPromiseWithRetries({promiseToTry:n.bind(this),exponentialBackoffBase:100,showNetworkSnackbar:!1})}return Promise.resolve({response:s.ok({}),retryCount:0})}};var c;function E(){const e=o.get_pathname();return"/h"===e?"HOME":"/recents"===e?"RECENTS":"/starred"===e?"STARRED":e.startsWith("/share")?"SHARED":"/requests"===e?"FILE_REQUESTS":"/deleted_files"===e?"DELETED_FILES":"/team/admin/content/home"===e?"CONTENT_MANAGER":e.startsWith("/collections")?"COLLECTIONS":"BROWSE"}e.WebUploadActionEvent=void 0,(c=e.WebUploadActionEvent||(e.WebUploadActionEvent={})).UPLOAD_ATTEMPT="upload_attempt",c.UPLOAD_FAILURE="upload_failure",c.UPLOAD_CANCELED="upload_canceled",c.UPLOAD_SUCCESS="upload_success",c.UPLOAD_METRICS="upload_metrics",c.UPLOAD_ABANDONED="upload_abandoned",c.UPLOAD_DEQUEUE="upload_dequeue",c.UPLOAD_HANGING="upload_hanging",c.UPLOAD_VISUALLY_COMPLETE="upload_visually_complete",c.UPLOAD_START_SUCCESS="upload_start_success",c.UPLOAD_APPEND_SUCCESS="upload_append_success";const p=new Set([o.WebUserActionLogEvent.UPLOAD_BUTTON_CLICK,o.WebUserActionLogEvent.ADD_MORE_FILES_CLICK,o.WebUserActionLogEvent.VIEW_DETAILS_CLICK,o.WebUserActionLogEvent.CLOSE_MODAL_CLICK,o.WebUserActionLogEvent.UPLOAD_FILES_CLICK,o.WebUserActionLogEvent.UPLOAD_FOLDER_CLICK,o.WebUserActionLogEvent.CANCEL_UPLOAD_CLICK,o.WebUserActionLogEvent.RETRY_UPLOAD_CLICK,o.WebUserActionLogEvent.UPLOAD_SCROLL_TO_ERRORS,o.WebUserActionLogEvent.UPLOAD_DRAWER_COLLAPSE,o.WebUserActionLogEvent.UPLOAD_DRAWER_EXPAND]);const u=[t.UploadErrorType.IGNORED,t.UploadErrorType.EMPTY_OR_FOLDER,t.UploadErrorType.INVALID_EXTENSION,t.UploadErrorType.INVALID_FILE_NAME,t.UploadErrorType.UPLOAD_PRECHECK_INVALID_CHAR_ERROR,t.UploadErrorType.PACKAGE_FILE],A=[t.UploadErrorType.PERMISSIONS_AT_UPLOAD_ERROR,t.UploadErrorType.OVER_QUOTA_ERROR,t.UploadErrorType.LOCKED_TEAM_ERROR,t.UploadErrorType.COMMIT_PERMISSIONS_ERROR],L=e=>{if(void 0!==e)return u.indexOf(e)>-1?t.UploadErrorClass.IGNORED:A.indexOf(e)>-1?t.UploadErrorClass.REJECTED:t.UploadErrorClass.ERROR};const O={},U=e=>e&&O[e]||r.UploadMethod.CHOOSER;e.getErrorClass=L,e.logUploadAction=function({action:r,upload:s,chooser_type:n,upload_method:c,num_files:u,num_invalid_files:A,num_files_abandoned:O,num_files_pending:R,total_file_size:C,num_dirs:D,errorType:g,extra:h,batchId:T,taskTrackingId:f,user:b,uploadPath:I,source:S,dropzoneArea:m}){var P;let v={num_files:u,num_invalid_files:A,num_files_abandoned:O,num_files_pending:R,total_file_size:C,num_dirs:D,chooser_type:n,upload_method:c,extra:Object.assign({origin:E(),uploader:t.getUploadSchedulerType(),default_drag_and_drop:i.DEFAULT_DRAG_AND_DROP,dropzone_area:m||"",display_upload_bytes_completed:a.DISPLAY_UPLOAD_BYTES_COMPLETED?"true":"false",effectiveConnection:(null===(P=null===navigator||void 0===navigator?void 0:navigator.connection)||void 0===P?void 0:P.effectiveType)||"na"},S&&{source:S})};if(function(e){return e&&!!e.uploadId}(s)){const n=s,a=r===e.WebUploadActionEvent.UPLOAD_FAILURE?n.errorType===t.UploadErrorType.GENERIC&&g?g:n.errorType:void 0;v=Object.assign(Object.assign({},v),{upload_id:n.uploadId,file_size:n.fileSize,file_extension:o.file_extension(n.name),failure_reason:a,error_class:L(a),batch_id:n.batchId,upload_destination:n.dest,current_path:o.get_pathname(),file_name:n.name,upload_method:U(n.uploadId),last_progress_time:n.lastProgressTime,percent_uploaded:n.percentUploaded,is_hanging_upload:n.isHangingUpload})}else if(function(e){return e&&!!e.batchId}(s)){const e=s;v=Object.assign(Object.assign({},v),{file_size:e.size,file_extension:o.file_extension(e.name),batch_id:e.batchId})}!v.chooser_type&&s&&"chooserType"in s&&s.chooserType&&(v.chooser_type=s.chooserType),T&&(v.batch_id=T),f&&(v.task_tracking_id=f),I&&(v.batch_dest_folder_level=t.getFolderLevel(I),b&&(v.member_folder=t.isInMemberFolder(b,I))),h&&(v.extra=Object.assign(Object.assign({},v.extra),h)),b?!function(e){return p.has(e)}(r)?(v.client_timestamp=Math.round(Date.now()/1e3),d.log(b.id,r,v)):o.WebUserActionLog.log(b.id,r,v):_.reportStack("Trying to log web upload event but user is null",{severity:l.SEVERITY.NONCRITICAL})},e.setMethodForFileUpload=(e,o)=>{O[e]=o}}));
//# sourceMappingURL=c_file_uploader_action_logger.js-vflDOYKKb.map
