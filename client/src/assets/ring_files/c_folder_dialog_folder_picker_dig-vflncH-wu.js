define(["require","exports","./c_tslib","./e_edison","./e_ui_page_files_router","./c_table_columns_file_name_column","./c_spectrum_icon_arrow_index","./c_keymaster","./c_browse_interface","./c_core_i18n","./e_core_exception","./c_breadcrumb_index","./c_core_exception_info"],(function(e,t,a,s,r,o,i,l,c,n,d,u,h){"use strict";const p=s.reactExports.memo((e=>{var{path:t,size:o,user:i,useFullPath:l,isForCurrentPath:c,setUrl:n}=e,d=a.__rest(e,["path","size","user","useFullPath","isForCurrentPath","setUrl"]);const h=r.normalize(t),p=r.Viewer.get_root_name(i),_=r.parent_dirs(h).reverse();return _.unshift(""),l&&""!==h&&_.push(h),s.reactExports.createElement(u.Breadcrumb,Object.assign({size:o,isRootOverflow:!0},d),_.map(((e,t)=>{const a=c&&t===_.length-1,o=a?void 0:r.browse_uri_for_fq_path(i,e).toString(),l=a?void 0:function(e,t){return a=>{0===a.button&&(a.altKey||a.ctrlKey||a.metaKey||a.shiftKey)||(a.preventDefault(),t(e))}}(e,n);return s.reactExports.createElement(u.Breadcrumb.Link,{key:r.filename(e,p),href:o,isCurrentPath:a,onClick:l,className:"file-breadcrumb-link"},r.getDisplayedFilename(r.filename(e,p)))})))}));p.displayName="FileBreadcrumb";const _=r.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){const{BoxEmptySpot:t}=yield new Promise((function(t,a){e(["./c_dig-illustrations_spot_box-empty"],t,a)}));return t}))}),E=r.Loadable({loader:()=>a.__awaiter(void 0,void 0,void 0,(function*(){const{TargetMissSpot:t}=yield new Promise((function(t,a){e(["./c_dig-illustrations_spot_target-miss"],t,a)}));return t}))}),S=r.requireCssWithComponent(_,["/static/metaserver/static/css/dig-illustrations/index.web-vfl45hs-6.css"]),m=r.requireCssWithComponent(E,["/static/metaserver/static/css/dig-illustrations/index.web-vfl45hs-6.css"]);class g{constructor(){this.getAccessLevel=e=>e.icon.endsWith(r.ACCESS_LEVEL$1.NO_ACCESS)||r.BACKUP_ICONS.includes(e.icon)?r.ACCESS_LEVEL$1.NO_ACCESS:e.icon.endsWith(r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT)?r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT:e.icon.endsWith(r.ACCESS_LEVEL$1.LIMITED_ACCESS)||e.read_only?r.ACCESS_LEVEL$1.LIMITED_ACCESS:r.ACCESS_LEVEL$1.ACCESS,this.convertJsonFolderToFolder=e=>{const{path:t,icon:a,has_subdirs:s,contained_ns:o}=e,i=this.getAccessLevel(e);return{path:t,isReadOnly:e.read_only,icon:a,hasSubfolders:s,isSelectable:i===r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT||i===r.ACCESS_LEVEL$1.ACCESS||i===r.ACCESS_LEVEL$1.LIMITED_ACCESS&&this.canSelectReadonly,isClickable:i===r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT||i===r.ACCESS_LEVEL$1.ACCESS||i===r.ACCESS_LEVEL$1.LIMITED_ACCESS&&(this.canSelectReadonly||s),nsId:o,isLockedVaultFolder:i===r.ACCESS_LEVEL$1.LIMITED_ACCESS_VAULT&&e.read_only}},this.cachedFolders=new Map}setProps(e,t,a,s){this.apiClient=e,this.user=t,this.canSelectReadonly=a,this.onDataLoaded=s}fetchFolderData(e){return a.__awaiter(this,void 0,void 0,(function*(){const t=yield this.apiClient.getFolderContents(this.user.id,e);if(this.onDataLoaded&&this.onDataLoaded(e),!t)return[];const a=t.map(this.convertJsonFolderToFolder),s=this.user.cdm_tmf_path&&r.paths_are_equal(e,"/")?[...a.filter((e=>r.paths_are_equal(e.path,this.user.cdm_tmf_path))),...a.filter((e=>!r.paths_are_equal(e.path,this.user.cdm_tmf_path)))]:a;return this.cachedFolders.set(r.normalize(e).toLowerCase(),s),s}))}fetchInstantFolderContents(e){const t=r.normalize(e);return this.cachedFolders.get(t.toLowerCase())}fetchFolderContents(e){return a.__awaiter(this,void 0,void 0,(function*(){const t=r.normalize(e);return this.fetchInstantFolderContents(e)||this.fetchFolderData(t)}))}}const f=o.createManagedTable(o.useFlexLayout,o.useKeyboarding);const C=({size:e})=>{const t=n.intl.formatMessage({id:"BAyazl",defaultMessage:"This is the only folder there is."});return s.React$1.createElement(n.Provider,{value:n.intl},s.React$1.createElement("div",{className:r.cx("folder-picker__empty-message","u-font-center",{"u-pad-top-xl":"small"!==e})},s.React$1.createElement(S,null),"small"===e?s.React$1.createElement("span",null,t):s.React$1.createElement("h2",{className:"u-pad-top-l"},t)))};C.displayName="EmptyMessage";const F=()=>s.React$1.createElement("div",{className:"folder-picker__error"},s.React$1.createElement(m,null),s.React$1.createElement("span",null,n.intl.formatMessage({id:"UIh+KT",defaultMessage:"Something went wrong on our end.  Please reload and try again."}))),v=()=>{const e=n.intl.formatMessage({id:"G09nql",defaultMessage:"Loading your foldersâ€¦"});return s.React$1.createElement(n.Provider,{value:n.intl},s.React$1.createElement("div",{className:"folder-picker-dig-loading "},s.React$1.createElement(r.Spinner,{"aria-valuetext":e,size:"xsmall"}),s.React$1.createElement("span",{className:"folder-picker-dig-loading-label"},e)))};class y{constructor(){this.appendReactableData=e=>{const t=[];return e.forEach(((e,a)=>{t.push(Object.assign(Object.assign({},e),{title:r.Emstring.em_snippet(r.filename(e.path),r.MAX_FOLDER_NAME_LENGTH),uniqueKey:""+e.nsId,isFolder:!0,isShared:!1,extension:"",path:e.path,index:a,isSelected:!1}))})),t},this.getDisplayableFolderList=e=>a.__awaiter(this,void 0,void 0,(function*(){const t=yield w.fetchFolderContents(e);return this.appendReactableData(t)})),this.getInstantDisplayableFolderList=e=>{const t=w.fetchInstantFolderContents(e);if(t)return this.appendReactableData(t)},this.getSingleCachedFolder=e=>{const t=this.getInstantDisplayableFolderList(r.parent_dir(e));let a=null;return null==t||t.some((t=>!!r.paths_are_equal(t.path,e)&&(a=t,!0))),a},this.getSingleFolder=e=>a.__awaiter(this,void 0,void 0,(function*(){let t=this.getInstantDisplayableFolderList(r.parent_dir(e));t||(t=yield this.getDisplayableFolderList(r.parent_dir(e)));let a=null;return null==t||t.some((t=>!!r.paths_are_equal(t.path,e)&&(a=t,!0))),a}))}}class b{constructor(){this.selectedIndex=0,this.prevKeyScope="",this.claimFocusAfterNavigate=!1,this.keysActive=!1,this.updateFolderData=e=>{this.folderData=e},this.handleChoice=()=>{if(!this.folderData[this.selectedIndex].isClickable)return;this.claimFocusAfterNavigate=!0;const e=this.folderData[this.selectedIndex];this.handleFolderChoice(e)},this.setupKeyboardShortcuts=()=>{this.changedFocusedFolder(),this.keysActive||(this.keysActive=!0,this.prevKeyScope=l.key.getScope(),this.prevKeyScope!==r.KEY_SCOPE&&l.key.setScope(r.KEY_SCOPE),l.key("up",r.KEY_SCOPE,(()=>{this.selectedIndex=this.selectedIndex-1,this.changedFocusedFolder()})),l.key("down",r.KEY_SCOPE,(()=>{this.selectedIndex=this.selectedIndex+1,this.changedFocusedFolder()})),l.key("left",r.KEY_SCOPE,(()=>{this.claimFocusAfterNavigate=!0,this.changedFocusedFolder(),this.goToParent()})),l.key("right",r.KEY_SCOPE,this.handleChoice),l.key("space",r.KEY_SCOPE,this.handleChoice),l.key("enter",r.KEY_SCOPE,(()=>{this.changedFocusedFolder(),this.handleChoice(),void 0!==this.onSuccess&&this.onSuccess()})))},this.cleanupKeyboardShortcuts=()=>{this.keysActive=!1,l.key.clearScope(r.KEY_SCOPE),this.prevKeyScope&&l.key.setScope(this.prevKeyScope),l.key.resetFilter()},this.setFocus=()=>{if(!this.claimFocusAfterNavigate)return;const e=document.querySelector(".folder-picker-container table tr");e&&(e.setAttribute("tabindex","-1"),e.focus()),this.claimFocusAfterNavigate=!1}}}const L=(e,t,a)=>{let s,r,o,i=!1;const{onFolderSelected:l,user:c,canSelectReadonly:n}=t;let d;e&&"/"!==e.path?(d=e.path,s=e.isLockedVaultFolder,r=e.nsId,i=e.isSelectable,o=e.isReadOnly):(d="",o="view"===c.user_root_permissions,i=!c.is_cdm_member||!o||n,r=c.root_ns_id),i||t.forceFolderSelectedCallback?l(d,r,a,s,o):l(void 0,void 0)},k=()=>{const e=n.intl.formatMessage({id:"oDXE4c",defaultMessage:"Based on previous activity and file type"});return s.React$1.createElement(r.Tooltip,{title:e},s.React$1.createElement(r.IconButton,{variant:"transparent"},s.React$1.createElement(r.UIIcon,{src:r.HelpLine,className:"icon-help","aria-label":e})))};k.displayName="SuggestionHeaderTooltip";const R=()=>{const e=n.intl.formatMessage({id:"qdhuuB",defaultMessage:"Suggested location"});return s.React$1.createElement("span",null,e,s.React$1.createElement(k,null))};R.displayName="SuggestionHeaderText";const x=e=>{const t=r.parent_dir(e.path),a=r.paths_are_equal(t,"/")?e.rootName:t.slice(1),o=n.intl.formatMessage({id:"R7F8Tb",defaultMessage:"in {location}"},{location:a});return s.React$1.createElement("a",{href:"#",className:"suggestion_parent",onClick:t=>{t.stopPropagation(),e.handleClick()}},o)};x.displayName="FolderSuggestionLocation";class A{constructor(e,t,s){this.fetch=()=>a.__awaiter(this,void 0,void 0,(function*(){try{const e=yield this.fetchFolderSuggestion(this.user.id);this.onFetch(e)}catch(e){const t=e.raw?e.raw.responseBody:"Received error response from folder suggestion API";d.reportException({err:new Error(t),tags:["folder_suggestion"],severity:h.SEVERITY.NONCRITICAL})}})),this.fetchFolderSuggestion=e,this.user=t,this.onFetch=s}}const I=e=>{const[t,a]=s.reactExports.useState(""),i={uniqueKey:e.path,title:r.filename(e.path),isFolder:!0,icon:t};let c="",n=!1;s.reactExports.useEffect((()=>{$.getSingleFolder(e.path).then((e=>{null!==e&&a(e.icon)}))}),[e.path]);const d=s.React$1.createElement(x,{path:r.parent_dir(e.path),handleClick:e.handleLocationClick,rootName:e.rootName});let u="folder-suggestion-location";return e.selected&&(u+=" folder-suggestion-location-selected"),s.React$1.createElement("div",{className:"folder-suggestion-dig",onFocus:()=>{n||(n=!0,c=l.key.getScope(),c!==r.SUGGESTED_LOCATION_KEY_SCOPE&&l.key.setScope(r.SUGGESTED_LOCATION_KEY_SCOPE),e.handleLocationClick())},onBlur:()=>{l.key.clearScope(r.SUGGESTED_LOCATION_KEY_SCOPE),c&&l.key.setScope(c),l.key.resetFilter()}},s.React$1.createElement(R,null),s.React$1.createElement("span",{role:"button",className:u,onClick:e.handleClick},s.React$1.createElement(o.FileNameCell,{file:i,subTitle:d})))};let w,$,N,P;I.displayName="FolderSuggestionDisplay";const D=e=>{var t;const[l,d]=s.reactExports.useState(null!==(t=e.initialPath)&&void 0!==t?t:"/"),u=s.reactExports.useRef(""),[h,_]=s.reactExports.useState([]),E=s.reactExports.useRef(!1),S=e.size||"standard",{showEmptyFolders:m,onError:k,onFolderSelected:R,onRowClicked:x}=e,[D,T]=s.reactExports.useState(void 0),[M,K]=s.reactExports.useState(!1),O=s.reactExports.useMemo((()=>{return t=e.currentUserPath,[{id:"filename",Cell:({row:{original:e}})=>s.React$1.createElement(o.FileNameCell,{file:e}),accessor:e=>e.title,width:300},{id:"current_folder_token",Cell:({row:{original:{path:e}}})=>e===t?s.React$1.createElement(r.AccessoryBadge,null,n.intl.formatMessage({id:"dNc7Si",defaultMessage:"Current folder"})):null,width:void 0},{id:"drilldown_arrow",accessor:e=>e.hasSubfolders?s.React$1.createElement(i.IconArrow,{name:"right"}):"",width:void 0}];var t}),[e.currentUserPath]),V=s.reactExports.useCallback((t=>{const a={user:e.user,canSelectReadonly:e.canSelectReadonly,onFolderSelected:R,forceFolderSelectedCallback:e.forceFolderSelectedCallback};null==x||x(t.path,t.index,!1),t.hasSubfolders||m||(u.current=t.path),d(t.path),L(t,a)}),[e.user,e.canSelectReadonly,e.forceFolderSelectedCallback,R,x,m]),q=s.reactExports.useCallback(((t,s)=>a.__awaiter(void 0,void 0,void 0,(function*(){d(t),K(null!=s);const a={user:e.user,canSelectReadonly:e.canSelectReadonly,onFolderSelected:e.onFolderSelected,forceFolderSelectedCallback:e.forceFolderSelectedCallback};$.getSingleFolder(t).then((e=>{L(e,a,s)}))}))),[e.user,e.canSelectReadonly,e.onFolderSelected,e.forceFolderSelectedCallback]);s.reactExports.useMemo((()=>{w=new g,$=new y,N=new b,N.goToParent=()=>{},N.onSuccess=e.onSuccess,N.changedFocusedFolder=()=>{K(!1)}}),[e.onSuccess]),s.reactExports.useMemo((()=>{w.setProps(e.apiClient,e.user,e.canSelectReadonly,e.onDataLoaded)}),[e.apiClient,e.user,e.canSelectReadonly,e.onDataLoaded]),s.reactExports.useEffect((()=>{(()=>{const e=new Image;e.src=s.static_url("/static/metaserver/static/images/illustration_catalog/dropbox_somethings_not_working-vfl2QXPxi.png"),e.srcset=s.static_url("/static/metaserver/static/images/illustration_catalog/dropbox_somethings_not_working@2x-vflkcbmXv.png")+" 2x"})()}),[]),s.reactExports.useEffect((()=>{e.apiClient.fetchFolderSuggestion&&(P=new A(e.apiClient.fetchFolderSuggestion,e.user,(t=>{var a,s;const{path:r,prediction_id:o,suggest_id:i}=t;if(r){const t={path:r,predictionId:o};null===(s=e.onFetchFolderSuggestionSuccess)||void 0===s||s.call(e,[t],i),T(t)}else null===(a=e.onFetchFolderSuggestionSuccess)||void 0===a||a.call(e,[],i)})),P.fetch())}),[e.apiClient.fetchFolderSuggestion,e.user,e.onFetchFolderSuggestionSuccess]),s.reactExports.useEffect((()=>{N.goToParent=()=>{q(r.parent_dir(u.current))}}),[q]),s.reactExports.useEffect((()=>{N.handleFolderChoice=V}),[V]),s.reactExports.useEffect((()=>{N.onSuccess=e.onSuccess}),[e.onSuccess]),s.reactExports.useEffect((()=>{N.updateFolderData(h),N.selectedIndex=0,N.setFocus()}),[h]),s.reactExports.useEffect((()=>{const e=()=>a.__awaiter(void 0,void 0,void 0,(function*(){let e=yield $.getDisplayableFolderList(l);0!=e.length||r.paths_are_equal(l,"/")||m||(e=yield $.getDisplayableFolderList(r.parent_dir(l))),u.current=l,_(e),q(l)}));(()=>{const t=$.getInstantDisplayableFolderList(l),a=$.getSingleCachedFolder(l);if(u.current&&void 0!==t&&t.length<1&&!r.paths_are_equal(l,"/"))u.current=l;else if(!u.current||!1!==(null==a?void 0:a.hasSubfolders)||m||r.paths_are_equal(l,"/")){if(t)return u.current=l,void _(t);try{R(void 0,void 0,void 0,void 0,!0),e()}catch(e){s=e,null==k||k(s),R(),E.current=!0}var s}else u.current=l})()}),[l,k,R,m]);const U=s.reactExports.useRef(!1);e.initialPath&&!U.current&&(U.current=!0,q(e.initialPath));const B=()=>l!==u.current;let z,Y=null;if(E.current)z=s.React$1.createElement(F,null);else if(B())z=s.React$1.createElement(v,null);else if(B()||h.length>0){const t=c.get_browse_root_name(e.user);void 0!==D&&(Y=s.React$1.createElement(I,{path:D.path,handleClick:()=>{var t;null===(t=e.onFolderSuggestionClick)||void 0===t||t.call(e,D),q(D.path,D.predictionId)},handleLocationClick:()=>{var t;null===(t=e.onFolderSuggestionLocationClick)||void 0===t||t.call(e,D),q(r.parent_dir(D.path),D.predictionId)},rootName:t,selected:M})),z=s.React$1.createElement("div",{className:"folder-picker-container folder-picker-dig-container",onFocus:N.setupKeyboardShortcuts,onBlur:N.cleanupKeyboardShortcuts},s.React$1.createElement(f,{isSelectable:!0,columns:O,data:h,showHeader:!1,getPropsForRow:e=>({disabled:!e.isClickable,onClick:()=>{V(e)},filename:e.title,className:e.isClickable?"":"not-clickable"})}))}else z=s.React$1.createElement(C,{size:S});return s.React$1.createElement(n.Provider,{value:n.intl},Y,s.React$1.createElement("div",{className:"folder-picker-dig__breadcrumbs"},s.React$1.createElement("h1",{className:"ax-visually-hidden"},r.filename(u.current)),s.React$1.createElement(p,{useFullPath:!0,isForCurrentPath:!0,user:e.user,setUrl:t=>{var a;null===(a=e.onBreadcrumbClicked)||void 0===a||a.call(e,t),q(t)},path:u.current,size:"small"})),z)};D.displayName="FolderPickerTableNoCss";const T=r.requireCssWithComponent(D,["/static/metaserver/static/css/browse/browse-vflpkVhOi.css","/static/metaserver/static/css/react/folder_picker-vflhBHl9O.css","/static/metaserver/static/css/scooter/scooter-scoped-vfl0EaHDR.css","/static/metaserver/static/css/dig-components/index.web-vflGcQt8W.css","/static/typescript/component_libraries/dig-experimental/src/index.web-vflMgkV3K.css"]);t.FileBreadcrumb=p,t.FolderPicker=T}));
//# sourceMappingURL=c_folder_dialog_folder_picker_dig.js-vflOev0v2.map
