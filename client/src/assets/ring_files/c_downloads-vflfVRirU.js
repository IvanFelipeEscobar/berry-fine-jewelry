define(["exports","./c_tslib","./e_ui_page_files_router","./c_src_sink_index","./c_core_browser_detection","./e_edison","./c_core_notify","./c_core_i18n","metaserver/static/js/modules/constants/files_spa","./c_apex-metrics_src_types","./e_core_exception","./c_core_exception_info","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","./c_lodash-es_lodash","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","./c_core_xhr","./c_csrf","./c_browser_cookies","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/undo_strings","metaserver/static/js/modules/core/langpack"],(function(e,t,o,s,r,a,n,i,d,c,l,u,_,m,f,p,w,g,h,v,b,y,j,M,k,x,z,U,I,S,A,E,q){"use strict";const L=["dl-web.dropbox.com","dl.dropboxusercontent.com"],R=".dropboxusercontent.com",Z=i.intl.formatMessage({id:"L64bdq",defaultMessage:"There was an error downloading your file."});let Q=!1,T={};function W({source:e,type:t}){s.getMetricsReporter().createStats({ns:"web_file_actions",name:"download/failed"},{source:e,type:t}).record(1)}const D=({url:e,error:t,source:o="unknown"})=>{const i=a.URI.parse(e),d=i.getAuthority();!function({source:e}){s.getMetricsReporter().createStats({ns:"web_file_actions",name:"download/attempt"},{source:e}).record(1)}({source:o});const c=L.includes(d)||d.endsWith(R)||"www.dropbox.com"===d;c||W({source:o,type:"download_non_block_server"}),a.assert(c,"attempt to download from a non-blockserver domain",{exc_extra:{domain:d,url:e}}),Q||(Q=!0,T={},window.addEventListener("message",J));const l=function(){let e="";for(let t=1;t<=4;t++)e+=String(Math.random()).split(".")[1];return e}();i.updateQuery({_download_id:l,_notify_domain:window.location.host});return N({downloadUri:i,downloadId:l,error:t,downloadDomain:d,onLoad:()=>{setTimeout((()=>{const e=T[l];null!=e&&(r.chrome&&(n.Notify.error(Z),e.error&&(e.error(),W({source:e.source,type:"download_failed"}))),O(l))}),100)},source:o}),!1},N=({downloadUri:e,downloadId:t,error:o,downloadDomain:s,onLoad:r,source:a})=>{const n=document.createElement("iframe");n.setAttribute("src",String(e)),n.style.display="none",r&&n.addEventListener("load",r),T[t]={origin:s,error:o,iframe:n,source:a},document.body.appendChild(n),window.setTimeout((()=>O(t)),9e4)},C=e=>{let t;t="too_many_files"===e[".tag"]?i.intl.formatMessage({id:"ZvH26K",defaultMessage:"Attempted to zip too many files."}):"too_much_data"===e[".tag"]?i.intl.formatMessage({id:"Qq4R12",defaultMessage:"Attempted to zip too much data."}):"file_not_found"===e[".tag"]?i.intl.formatMessage({id:"XSR4O8",defaultMessage:"File not found."}):"unauthorized_user"===e[".tag"]?i.intl.formatMessage({id:"tUjhJf",defaultMessage:"Unauthorized user."}):"unauthorized_namespace"===e[".tag"]?i.intl.formatMessage({id:"62VIQy",defaultMessage:"You can't download because you can't access all content.  Please try again, selecting only folders where you have access to all the content."}):i.intl.formatMessage({id:"ItwtZa",defaultMessage:"Zip download failed."}),o.Snackbar.fail(t,"zip-download-status")},H=({block_hash:e,fq_paths:s,parent_path:r,flat_mode:a,subjectUserId:n,root_ns_id:i})=>t.__awaiter(void 0,void 0,void 0,(function*(){try{const t=new o.UserApiV2Client;return{result:yield t.ns("browse_zip_downloads").rpc("get_zip_download_url",{block_hash:e,unnormalized_files:[...s],parent_path:r,flat_mode:a,root_ns_id:i},{subjectUserId:n}),isError:!1}}catch(e){return".tag"in e.error?{isError:!0,error:e.error}:{isError:!0,error:{".tag":"undefined_error"}}}}));function J(e){const t=a.URI.parse(e.origin);if("https"!==t.getScheme())return;if(!L.includes(t.getAuthority())&&!t.getAuthority().endsWith(R))return;let o;try{o=JSON.parse(e.data)}catch(e){return}if(!o||!o.download_id)return;const s=T[o.download_id];if(null!=s&&t.getAuthority()===s.origin&&e.source===s.iframe.contentWindow){if("failed"===o.status){const e=(o.message||Z)+'<a target="_blank" rel="noreferrer" href="/help/desktop-web/download-entire-folders">'+i.intl.formatMessage({id:"WYQtmB",defaultMessage:"More info"})+"</a>";n.Notify.error(new n.HTML(e)),s.error&&(s.error(),W({source:s.source,type:"download_failed"}))}O(o.download_id)}}function O(e){const t=T[e];null!=t&&(t.iframe.remove(),delete T[e])}e.get=D,e.getZipDownloadUrl=H,e.get_zip=function({fq_paths:e,subject_uid:o,block_hash:s,parent_path:r,flat_zip_mode:a,source:n="unknown",root_ns_id:i}){return t.__awaiter(this,void 0,void 0,(function*(){""===r&&(r="/");const t=yield H({block_hash:s,fq_paths:[...e],parent_path:r,flat_mode:!!a,subjectUserId:o,root_ns_id:i});if(t.isError)C(t.error),W({source:n,type:"zip_download_error"});else{const{url:e}=t.result;D({url:e,source:n})}}))},e.showGetZipUrlErrorSnackbar=C}));
//# sourceMappingURL=c_downloads.js-vflMWpioz.map
