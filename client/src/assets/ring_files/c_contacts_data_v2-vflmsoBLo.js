define(["exports","./c_lodash-es_lodash","./e_ui_page_files_router","./c_contacts_bloodhound","metaserver/static/js/modules/constants/contacts","./e_edison","./e_core_exception","./c_profile_services_profile_services_link","./c_browser_cookies"],(function(t,e,s,r,i,n,c,o,a){"use strict";function _(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(s){if("default"!==s){var r=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,r.get?r:{enumerable:!0,get:function(){return t[s]}})}})),e.default=t,Object.freeze(e)}var h,l=_(i);!function(t){t[t.ALL=0]="ALL",t[t.INDIVIDUAL=1]="INDIVIDUAL"}(h||(h={}));const u={ALL:{getUrl:"/contacts/get",refreshUrl:"/contacts/refresh",boltAppId:"contacts_cache_notify"},INDIVIDUAL:{getUrl:"/contacts/get_individual_for_user",refreshUrl:"/contacts/refresh_individual_for_user",boltAppId:"individual_contacts_cache_notify"}};class d{constructor(t,e){this.filterContacts=this.filterContacts.bind(this),this.length=this.length.bind(this),this.slice=this.slice.bind(this),this.includeForUser=this.includeForUser.bind(this),this.includeForViewer=this.includeForViewer.bind(this),this.excludeByEmail=this.excludeByEmail.bind(this),this.excludeMe=this.excludeMe.bind(this),this.excludeNewStyleGroups=this.excludeNewStyleGroups.bind(this),this.excludeFacebook=this.excludeFacebook.bind(this),this.excludeTeamMembers=this.excludeTeamMembers.bind(this),this.excludePairedUserDuplicates=this.excludePairedUserDuplicates.bind(this),this.excludeNonTeam=this.excludeNonTeam.bind(this),this.excludeNonTeamActive=this.excludeNonTeamActive.bind(this),this.excludeSuspended=this.excludeSuspended.bind(this),this.sortByTeamFirst=this.sortByTeamFirst.bind(this),this._excludeType=this._excludeType.bind(this),this._lowercaseContact=this._lowercaseContact.bind(this),this.contacts=t,this.owningUserId=e,this.lcontacts=Array.from(this.contacts).map((t=>this._lowercaseContact(t)))}static create_contacts_list(t){return new d(t,null)}static create_per_user_contacts_list(t,e){return new d(t,e)}filterContacts(t){const e=this.contacts.filter(t);return new d(e,this.owningUserId)}length(){return this.contacts.length}slice(t,e){return new d(this.contacts.slice(t,e),this.owningUserId)}includeForUser(t){if(null!=this.owningUserId)return this.owningUserId===t?this:new d([],t);{const e=this.contacts.filter((e=>e.owning_user_id===t));return new d(e,t)}}includeForViewer(t){const e=t.get_user_ids();return this.filterContacts((t=>Array.from(e).includes(t.owning_user_id)))}excludeByEmail(t){return t=t?t.toLowerCase():"",this.filterContacts((e=>!(t===e.email.toLowerCase())))}excludeMe(){return this.filterContacts((t=>!t.is_owner))}excludeNewStyleGroups(){return this._excludeType(s.ContactTypes.NEW_STYLE_GROUP)}excludeFacebook(){return this._excludeType(s.ContactTypes.FB)}excludeTeamMembers(){return this.filterContacts((t=>!t.team))}excludePairedUserDuplicates(){return this.filterContacts((t=>!t.paired_user_duplicate))}excludeNonTeam(){return this.filterContacts((t=>t.team))}excludeNonTeamActive(){return this.filterContacts((t=>t.team&&"active"===t.join_state))}excludeSuspended(){return this.filterContacts((t=>"suspended"!==t.join_state))}sortByTeamFirst(){return new d(d.sortContactsByTeamFirst(this.contacts),this.owningUserId)}static sortContactsByTeamFirst(t){const e=[],s=[];for(const r of Array.from(t))r.team?e.push(r):s.push(r);return e.concat(s)}_excludeType(t){return this.filterContacts((e=>e.type!==t))}_lowercaseContact(t){const e={};for(const s in t){let r=t[s];("string"==typeof r||r instanceof String)&&(r=r.toLowerCase()),e[s]=r}return e}}class f{constructor(t){this.callbacks={},this.one_time_callbacks=[],this.cached_contacts=null,this._cache_download_name=t,this.should_force_refresh=!1,this.request_perf_records=[],this._config=null}static initClass(){this.MAX_REQUEST_PERF_RECORDS=20}register_for_updates(t,e){this.callbacks[t]=e}unregister_for_updates(t){null!=this.callbacks[t]&&delete this.callbacks[t]}get_contacts_count(){return null!=this.cached_contacts?this.cached_contacts.length():0}get_downloaded_time(){const t=window.performance.getEntriesByName(this._get_contacts_downloaded_mark_name());return t&&t.length?t[0].startTime:null}get_request_perf_records(){return this.request_perf_records}_is_contact_get_or_check_ajax_request(t){const{initiatorType:e}=t,{name:s}=t;return"xmlhttprequest"===e&&s.endsWith(this._config.getUrl)}_find_last_perf_entry(t=500){const e=window.performance.getEntriesByType("resource");if(e.length){for(let s=Math.min(e.length-1,t);s>=0;s--)if(this._is_contact_get_or_check_ajax_request(e[s]))return e[s]}return null}_record_perf_stats(t={}){const e=this._find_last_perf_entry();if(e&&(t.ttfb=e.responseStart-e.requestStart,t.downloading_time=e.responseEnd-e.responseStart,t.duration=e.duration,this.request_perf_records.push(t),this.request_perf_records.length>f.MAX_REQUEST_PERF_RECORDS))return this.request_perf_records=this.request_perf_records.slice(this.request_perf_records.length-1)}_get_request_url(){throw new Error("method unimplemented")}_get_request_params(){throw new Error("method unimplemented")}_contacts_loaded_callback(t){throw new Error("method unimplemented")}_fetch_contacts(t){return s.BackgroundRequest(Object.assign(Object.assign({url:this._get_request_url(),data:this._get_request_params()},t?{subject_user:t}:{}),{success:(t,e,s)=>{const r=JSON.parse(t);if(this._contacts_loaded_callback(r),this._schedule_fetch)return this._schedule_fetch()}}))}_get_versioned_params(t,e=!0){const s={version:t};return e&&(s.force_refresh=this.should_force_refresh,this.should_force_refresh=!1),null!=this.digest&&(s.digest=this.digest),null!=this.limit&&(s.limit=this.limit),s}_get_contacts_downloaded_mark_name(){return`${this._cache_download_name}-${this.instance}`}_is_page_hidden(){return null!=window.document.visibilityState&&window.document.hidden}_add_one_time_callback(t){if(null!=t&&!Array.from(this.one_time_callbacks).includes(t))return this.one_time_callbacks.push(t)}_invoke_all_callbacks(t){return this._invoke_callbacks(this.one_time_callbacks,t,!0),this._invoke_callbacks(this.callbacks,t,!1)}_invoke_one_time_callbacks(t){return this._invoke_callbacks(this.one_time_callbacks,t,!0)}_invoke_callbacks(t,e,s){return(()=>{const r=[];for(const i of Array.from(Object.keys(t)))t[i](e),s?r.push(delete t[i]):r.push(void 0);return r})()}}f.initClass();class m extends f{constructor(t,e=null,s=null){super("BoltContactsCache download"),this.bolt_update_callback=this.bolt_update_callback.bind(this),this.bolt_refresh_callback=this.bolt_refresh_callback.bind(this),this.cache_type=t,this.limit=e,this.user_id=s,this.instance=m.INSTANCE++,this.loading_state=m.BOLT_NEED_TO_SEND_REQUEST,this._config=u[h[this.cache_type]],this.current_bolt_states=null,this._notified_states={},this._bolt=null,this._last_refresh_ts=null}static initClass(){this.INSTANCE=0,this.BOLT_NEED_TO_SEND_REQUEST=0,this.BOLT_REQUEST_SENT=1,this.REFRESH_THRESHOLD=36e5}load_contacts(t,e){s.Viewer.get_viewer().is_signed_in&&(this._add_one_time_callback(e),(this.loading_state===m.BOLT_NEED_TO_SEND_REQUEST||t)&&(this.loading_state=m.BOLT_REQUEST_SENT,t&&(this.should_force_refresh=!0),this._fetch_contacts(this._getUserId())),!this._should_update_contacts()&&this.is_loaded()&&this._invoke_one_time_callbacks(this.cached_contacts))}refresh_contacts(t=!1){const e=window.performance.now();if(this._last_refresh_ts||(t=!0),!t&&this._last_refresh_ts&&e-this._last_refresh_ts<m.REFRESH_THRESHOLD)return;const r=this._getUserId();return s.BackgroundRequest(Object.assign({url:this._get_refresh_url(),data:this._get_refresh_params({force_refresh:t})},r?{subject_user:r}:{})),this._last_refresh_ts=e}is_loaded(){return null!=this.cached_contacts}bolt_update_callback(t){for(const e of Array.from(t))(!Array.from(this._notified_states).includes(e.unique_id)||+this._notified_states[e.unique_id].revision<+e.revision)&&(this._notified_states[e.unique_id]=e);return this._should_update_contacts()&&(this.loading_state=m.BOLT_NEED_TO_SEND_REQUEST),this.load_contacts()}bolt_refresh_callback(t){if(null!=this._bolt&&this._bolt.unsubscribe(),this._bolt=null,this.loading_state=m.BOLT_NEED_TO_SEND_REQUEST,!this._is_page_hidden())return this.load_contacts()}_contacts_loaded_callback(t){if(this._is_old_contacts(t.bolt_info))return;const e=this._is_new_contacts(t.bolt_info);return this.current_bolt_states=t.bolt_info,null==this._bolt&&this._subscribe_to_bolt(),e&&(null!=t.contacts?t.contacts.length:void 0)?(this._record_perf_stats({num_contacts:t.contacts.length}),this.digest=t.digest,this._create_contacts_list(t.contacts),this._invoke_all_callbacks(this.cached_contacts),window.performance.mark(this._get_contacts_downloaded_mark_name())):void 0}_create_contacts_list(t){return this.cached_contacts=d.create_contacts_list(t)}_subscribe_to_bolt(){const t=[];for(const e in this.current_bolt_states){const r=this.current_bolt_states[e];t.push(new s.SignedChannelState(this._config.boltAppId,e.toString(),r.revision,r.token))}return this._bolt=new s.BoltClient(t,this.bolt_update_callback,this.bolt_refresh_callback),this._bolt.start()}_is_new_contacts(t){return this._first_contacts_are_newer(t,this.current_bolt_states)}_is_old_contacts(t){return this._first_contacts_are_newer(this.current_bolt_states,t)}_first_contacts_are_newer(t,e){if(!e)return!0;for(const s in e){const r=e[s];for(const e in t){const i=t[e];if(e===s&&+r.revision<+i.revision)return!0}}return!1}_should_update_contacts(){return this._is_new_contacts(this._notified_states)}_get_request_params(){return this._get_versioned_params(1)}_get_request_url(){return this._config.getUrl}_get_refresh_params(t={}){return t}_get_refresh_url(){return this._config.refreshUrl}_getUserId(){var t;const e=null!==(t=this.user_id)&&void 0!==t?t:s.getActiveUserId();return void 0===e&&c.reportStack("Contacts API request from BoltContactsCache without subject user",{tags:["contacts-uid-aware-migration"]}),e}}m.initClass();class g extends m{constructor(t,e){n.assert(null!=e.id,"user has invalid id"),super(t,null,e.id),this.cache_type=t,this.user=e}_create_contacts_list(t){return this.cached_contacts=d.create_per_user_contacts_list(t,this.user.id)}}class p{constructor(t){this.cacheType=t}}class C extends p{getOrCreateForUser(t){if(!s.Viewer.get_viewer().is_uid_associated(t.id))throw new Error("Requested contacts cache for a user not associated with the current viewer.");return this.getOrCreateForViewer()}getOrCreateForViewer(){return null==this.contactsCache&&(this.contactsCache=new m(this.cacheType)),this.contactsCache}}const b=new C(h.ALL);let w=b;"OFF"!==l.LEGACY_CACHE_LIMIT&&(w=new C(h.ALL),w.contactsCache=new m(h.ALL,+l.LEGACY_CACHE_LIMIT));const E=new class extends p{constructor(){super(...arguments),this.uidToContactsCache={}}getOrCreateForUser(t){return t.id in this.uidToContactsCache||(this.uidToContactsCache[t.id]=new g(this.cacheType,t)),this.uidToContactsCache[t.id]}}(h.INDIVIDUAL);var T;!function(t){t[t.ALL_LOCAL=0]="ALL_LOCAL",t[t.INDIVIDUAL_LOCAL_TEAM_REMOTE=1]="INDIVIDUAL_LOCAL_TEAM_REMOTE"}(T||(T={}));const y=[T.ALL_LOCAL],L={ALL_LOCAL:{localCacheStore:b,sufficientResults:1e3,remoteDebounceWait:10},INDIVIDUAL_LOCAL_TEAM_REMOTE:{localCacheStore:E,remoteEndpoint:"/team/search_contacts",remoteBatchEndpoint:"/team/search_contacts_batch",sufficientResults:1e3,remoteDebounceWait:10}};function k(t){return l.MERGE_SEARCH_ALLOWED[t.id]?T.INDIVIDUAL_LOCAL_TEAM_REMOTE:T.ALL_LOCAL}function O(t){return L[T[k(t)]]}const S={},A={getOrCreateForUser(t){if(t.id in S)return S[t.id];const e=O(t);let i;if(e.remoteEndpoint){const s=String(t.id);i={url:U(e.remoteEndpoint),prepare:(t,e)=>{var r;const i=new FormData;return i.append("query",JSON.stringify(t)),i.append("_subject_uid",s),Object.assign(Object.assign({},e),{method:"POST",headers:{"X-CSRF-Token":null!==(r=a.Cookies.read("__Host-js_csrf"))&&void 0!==r?r:"","X-Dropbox-Uid":s},body:i,fingerprint:`${t}:${s}`})}}}const n=new r.Bloodhound({datumTokenizer:s.ContactCommon.get_index_tokens,queryTokenizer:r.Bloodhound.tokenizers.whitespace,identify:s.ContactCommon.get_key,sufficient:e.sufficientResults,sorter:s.ContactCommon.sorter,local:[],remote:i});if(S[t.id]=n,s.Viewer.get_viewer().is_user_signed_in(t)){const s=e.localCacheStore.getOrCreateForUser(t);s.load_contacts(!1,(e=>{v(t,e),s.register_for_updates("bloodhound_contacts_v2",(e=>{v(t,e)}))}))}return o.LinkedProfileServices.get_linked_profile_services_for_user(t.id).register_for_service_changes("bloodhound_contacts_v2",(()=>{n.clearRemoteCache()})),S[t.id]},search:(t,e,s,r)=>{const i=A.getOrCreateForUser(t),n=O(t);if(!e)return s([]),void(r&&n.remoteEndpoint&&r([]));const c=n.localCacheStore.getOrCreateForUser(t);c.is_loaded()?i.search(e,s,r):c.load_contacts(!1,(t=>{i.search(e,s,r)})),c.refresh_contacts(!1)},getAll:t=>A.getOrCreateForUser(t).all(),clearCache(t){delete S[t.id]}};function v(t,e){!function(t,e){if(!(t.id in S))return;const r=S[t.id];e=e.filter(s.ContactCommon.is_valid),r.clearRemoteCache(),r.clear(),r.add(e)}(t,e.includeForUser(t.id).contacts)}function U(t){const e=".dropbox.com",s=document.createElement("a");s.href=t;const r=s.hostname||window.location.hostname;if(-1===r.indexOf(e,r.length-12))throw new Error("Cannot send the CSRF token to "+r);return t}const x=t=>e.debounce(t,10,{leading:!0,trailing:!0});class D{constructor(t,e,r=!0,i=!0){this.searchInternal=x(((t,e,s)=>{if(""===(t=D.normalizeQuery(t)))return e([]),void(s&&s([]));A.search(this.user,t,(s=>this.processMatches(s,e,t)),(e=>this.processMatches(e,s,t)))})),this.searchBatchInternal=x(((t,e,r)=>{const i=t.map(D.normalizeQuery).filter((t=>t.length>0)),n={};for(const t of i){const e=e=>{n[t]=this.processMatches(e,void 0,t)};A.search(this.user,t,e)}if(e(n),!this.searchConfig.remoteBatchEndpoint)return;this.searchRemoteBatch(i,(t=>{if(!r)return;const e={};for(const r in t)if(t.hasOwnProperty(r)){const i=n[r].map(s.ContactCommon.get_key),c=t[r].filter((t=>{const e=s.ContactCommon.get_key(t);return i.every((t=>t!==e))}));e[r]=this.processMatches(c)}r(e)}))})),this.query=this.search,this.query_batch=this.searchBatch,this.user=t,this.filterFunc=e,this.excludeDomainContacts=r,this.excludeDirectoryRestrictedContacts=i,this.searchConfig=O(t),this.searchMode=k(t),this.searchModeName=T[this.searchMode],A.getOrCreateForUser(this.user)}search(t,e,s){this.searchInternal(t,e,s)}searchBatch(t,e,s){const r=this.searchConfig.localCacheStore.getOrCreateForUser(this.user);if(r.is_loaded())return this.searchBatchInternal(t,e,s);r.load_contacts(!0,(()=>this.searchBatchInternal(t,e,s)))}normalizeQuery(t){return t.trim().toLowerCase()}isSearchLocalOnly(){return-1!==y.indexOf(this.searchMode)}getStats(){const t=this.searchConfig.localCacheStore.getOrCreateForUser(this.user);return{numLocalContacts:t.get_contacts_count(),localContactsDownloadedTime:t.get_downloaded_time()}}searchRemoteBatch(t,e){s.WebRequest({url:this.searchConfig.remoteBatchEndpoint,type:"post",subject_user:this.user.id,dataType:"json",data:{queries:JSON.stringify(t)},success:e})}isTeamContact(t){return this.user.is_team&&null!=t.team&&t.team}static isDirectoryRestrictedContact(t,e){const s=!!t.is_directory_restricted,r=e&&e===t.email;return s&&!r}processMatches(t,e,r){const i=[];for(const e of t){r&&(e.nameMatch=s.fuzzy.match(r,e.name||""),e.emailMatch=s.fuzzy.match(r,e.email||"")),e.on_team=!(e.type===s.ContactTypes.FB||!this.isTeamContact(e));const t=new s.Contact(e);t.pending=!1;const n=this.excludeDomainContacts&&t.domain_contact,c=this.excludeDirectoryRestrictedContacts&&D.isDirectoryRestrictedContact(t,r);n||c||this.filterFunc&&!this.filterFunc(t)||i.push(t)}return e&&e(i),i}getAll(t){const e=this.searchConfig.localCacheStore.getOrCreateForUser(this.user);if(e.is_loaded()){const e=A.getAll(this.user).map((t=>new s.Contact(t))),r=this.filterFunc?e.filter(this.filterFunc):e;t(r)}else e.load_contacts(!0,(e=>{if(e){const s=e.contacts,r=this.filterFunc?s.filter(this.filterFunc):s;t(r)}}))}}D.normalizeQuery=t=>t.trim().toLocaleLowerCase(),t.BloodhoundContactsV2=A,t.CONTACTS_SEARCH_PREEMPTED_THRESHOLD=300,t.ContactsDataSourceV2=D,t.getSearchConfigForUser=O}));
//# sourceMappingURL=c_contacts_data_v2.js-vfl_22skX.map
