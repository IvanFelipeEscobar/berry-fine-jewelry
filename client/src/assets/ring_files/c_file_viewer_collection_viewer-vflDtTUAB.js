define(["exports","./c_lodash-es_lodash","./e_edison","./e_ui_page_files_router","./c_file_store_utils","./c_previews_data_actions","./c_file_viewer_sdk_file_viewer_file_viewer","./c_file_viewer_data_store","./c_history","./c_src_sink_index","./c_file_viewer_logging_performance","./c_file_viewer_utils","./c_action_plugins_open_in_action_hooks","./c_core_logging_constants","./c_tslib","./c_apex-metrics_src_types","metaserver/static/js/modules/constants/files_spa","./c_core_i18n","./e_core_exception","./c_core_exception_info","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","metaserver/static/js/modules/core/langpack","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","./c_core_xhr","./c_csrf","./c_browser_cookies","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","./c_core_notify","metaserver/static/js/modules/constants/locales","./c_core_browser_detection","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/undo_strings","./c_extensions_cloud_docs_compat","./c_integrations_data_selectors","./c_downloads","./c_share_download_ui_api","./c_portable_delete_snackbars","./c_action_bar_action_bar_strings","./c_portable_delete_strings","./c_file_actions_strings","./c_files_view_file_actions_snackbars","./c_file_viewer_file_viewer_components","./c_core_data_utils","./c_core_data_preview_key","./c_core_types_preview_type","./c_file_viewer_file_extension_extension_constants","./c_src_simple-action-bar_action_bar_types","./c_api_v2_redux_files","./c_resize-observer-polyfill_dist_ResizeObserver","./c_truncate_index","./c_file_viewer_toolbar","./c_breadcrumb_index","./c_file_viewer_sdk_file_viewer_experiments","metaserver/static/js/modules/constants/file_viewer_configuration","metaserver/static/js/modules/constants/file_viewer_feature_experiments","metaserver/static/js/modules/constants/file_viewer_flows_experiments","./c_auth_login_or_register_types","./c_form_row_index","./c_ui_tree_view","./c_icon_folder_icon","./c_sharing_ui_notifications_util","./c_src_utils_logging","./c_account_email_verify_reasons","./c_account_email","./c_ui_modal_dig","./c_ui_input_dig","./c_loggers_device_type","./c_common_logging_uxa","./c_share_modal_evolution_utils_logging","./c_dig-illustrations_spot_file-folders","./c_pass_store","./c_sharing_share_page_action_types","metaserver/static/js/modules/constants/python","./c_flux_base_store","./c_sharing_ui_util","./c_contacts_contact_token_state","./c_icon_icon_helper","./c_sharing_gating_util","./c_sharing_settings_utils_sharing_settings_util","./c_preview_audio_video_video_editing_utils","./c_components_approval-forms_url_utils","./c_capture_api","./c_pap-events_previews_rename_file","./c_pap-events_filesystem_item_actions_unstar_file","./c_pap-events_enums_file_type-utils","./c_pap-events_navigation_navigate_to_edit","./c_pap-events_previews_crop_rotate_select_rotate","./c_src_preview-photo-editor_types","./c_pap-events_previews_create_folder","./c_keymaster","./c_bug_reporting_routing","./c_clipboard_v3","metaserver/static/js/modules/constants/publish","./c_file_viewer_mobile_web","./c_capture_redux_selectors","./c_flows_flows_client","./c_docsend_src_utils","./c_components_approval-forms_approval_metadata","./c_contacts_data_v2","./c_contacts_bloodhound","metaserver/static/js/modules/constants/contacts","./c_profile_services_profile_services_link","./c_profile_services_profile_services_constants","metaserver/static/js/modules/constants/login_and_register","./c_flows_approval_approval_io_client","./c_typeahead_index","./c_src_common_format_bytes","./c_info_blade_content_metadata_image_metadata","./c_src_simple-action-bar_inline_action_bar","./c_src_highlighted-truncated-string_em-string","./c_extensions_split_share_button","./c_team_discovery_data_utils","./c_spectrum_avatar_avatar_initials","./c_spectrum_positioned_portal","./c_growth_ui_teams_web_actions_logger_events","./c_teams_let_members_invite_non_admin_invite_modal","./c_contacts_tokenizer_v2","./c_integrations_profile_card_tooltip","./c_src_text","./c_spectrum_colorized_icon","./c_icon_templates_stateless_index","./c_spectrum_svg_icon_bundle","./c_src_instrumentation_common_context","./c_src_instrumentation_constants","./c_src_instrumentation_function_wrapper","./c_preview_audio_video_video_editing_strings","./c_file_viewer_toolbar_v2_toolbar_holder","./c_campaigns_campaigns_element_id_enum","./c_flows_constants","./c_src_components_action-bar-strings","./c_integrations_hellosign_deep_integration_constants","./c_ui_hoc","./c_ux_analytics_dispatch_custom_event"],(function(e,i,t,s,r,n,o,a,c,l,_,p,u,d,h,f,v,w,m,g,S,F,O,T,I,E,C,x,P,R,y,b,V,N,k,D,L,j,A,H,K,U,M,$,B,W,q,Q,Y,z,G,J,X,Z,ee,ie,te,se,re,ne,oe,ae,ce,le,_e,pe,ue,de,he,fe,ve,we,me,ge,Se,Fe,Oe,Te,Ie,Ee,Ce,xe,Pe,Re,ye,be,Ve,Ne,ke,De,Le,je,Ae,He,Ke,Ue,Me,$e,Be,We,qe,Qe,Ye,ze,Ge,Je,Xe,Ze,ei,ii,ti,si,ri,ni,oi,ai,ci,li,_i,pi,ui,di,hi,fi,vi,wi,mi,gi,Si,Fi,Oi,Ti,Ii,Ei,Ci,xi,Pi,Ri,yi,bi,Vi,Ni,ki){"use strict";const Di=a.getStoreForFileViewer();function Li(e,t,s){const n=r.getFileRevisionOrHrefId(e);let o=i.find(t,(e=>r.getFileRevisionOrHrefId(e)===n));if(!o){const s=e.file_id;o=i.find(t,(e=>e.file_id===s))}if(!o&&t.length>0&&void 0!==s){let e=s;return s>=t.length&&(e=t.length>1?t.length-1:0),{newFile:t[e],files:t,newIndex:e}}o||(o=e);const a=t.indexOf(o);return-1===a?{newFile:o,files:[o],newIndex:0}:{newFile:o,files:t,newIndex:a}}function ji({file:e,files:i,sharedLinkInfos:t,sharePermissions:s,shareTokens:r,oldIndex:n}){const o=i.filter((e=>!e.is_dir)),{newFile:a,newIndex:c}=Li(e,o,n);return{collection:{file:a,files:o,sharedLinkInfos:t,sharePermissions:s,shareTokens:r},currentIndex:c}}class Ai extends t.React$1.Component{constructor(e){super(e),this.hasFlipped=!1,this.updateFileViewer=()=>{const{file:e}=this.props;this.openFile(e)},this.onFileChanged=(e,i)=>{const t=this.state.collection.files[this.state.currentIndex];if(e.revision_id===t.revision_id&&r.isBrowseFile(t))if(i){const e=Object.assign(Object.assign({},t),{file_id:i.file_id,revision_id:i.revision_id,fq_path:i.fq_path}),s=this.state.collection.files.map(((i,t)=>t===this.state.currentIndex?e:i));this.setState({collection:Object.assign(Object.assign({},this.state.collection),{files:s})})}else{const{newFile:e,newIndex:i}=Li(t,this.state.collection.files,this.state.currentIndex);i<this.state.collection.files.length-1?this.setState({collection:Object.assign(Object.assign({},this.state.collection),{file:e}),currentIndex:i}):this.closeViewer()}},this.handleFlipNext=i.throttle((()=>{const{collection:e,currentIndex:i}=this.state;this.props.onFlipNext&&this.props.onFlipNext();const t=i+1===e.files.length?0:i+1;this.hasFlipped=!0,this.switchFile(t)}),100),this.handleFlipPrevious=i.throttle((()=>{const{collection:e,currentIndex:i}=this.state;this.props.onFlipPrevious&&this.props.onFlipPrevious();const t=0===i?e.files.length-1:i-1;this.hasFlipped=!0,this.switchFile(t)}),100),this.switchFile=e=>{const{collection:i}=this.state,t=i.files[e];this.updatePreviewUrl(t),this.setState({currentIndex:e},(()=>{this.openFile(t)}))},this.closeViewer=()=>{const{onCloseViewer:e}=this.props;e&&e()},this.state=ji(e),_.PreviewsEventLogger.mark(_.PreviewsTimingEvents.COLLECTION_VIEWER_CODE_START),this.setupPreviewUrl(this.props.file),this.updateFileViewer()}componentDidMount(){_.PreviewsEventLogger.mark(_.PreviewsTimingEvents.COLLECTION_VIEWER_MOUNT)}componentDidUpdate(e){if(function(e,i){const{file:t,files:s,sharedLinkInfos:r,sharePermissions:n,shareTokens:o}=e;return t!==i.file||s!==i.files||r!==i.sharedLinkInfos||n!==i.sharePermissions||o!==i.shareTokens}(e,this.props)){const e=this.state.currentIndex,i=this.hasFlipped?this.state.collection.files[e]:this.props.file,t=ji(Object.assign(Object.assign({},this.props),{file:i,oldIndex:e})),s=t.collection.file,r=e!==t.currentIndex,n=i.file_id!==s.file_id,o="fq_path"in i&&"fq_path"in s&&i.fq_path!==s.fq_path;this.setState(t,(()=>{(r||n||o)&&(this.updatePreviewUrl(s),this.openFile(s))}))}}componentWillUnmount(){const{onClose:e}=this.props;e&&e(),this.teardownPreviewUrl()}openFile(e){this.props.openFile(e)}setupPreviewUrl(e){this.props.skipOuterRouting||this.setPreviewUrl(e)}updatePreviewUrl(e){this.setPreviewUrl(e,!1),"preview_file_flip"!==s.getSpaProductName()&&s.setSpaProductName("preview_file_flip")}teardownPreviewUrl(){this.props.skipOuterRouting||this.setPreviewUrl(null)}setPreviewUrl(e,i=!0){if(this.props.disableRouting)return;const s=t.URI.parse(c.DBHistory.get_url()),n=t.URI.encode_parts(s.getPath());let o=s.removeQuery("select").removeQuery("page");if(null==e)o=o.removeQuery("preview"),o=o.removeQuery("t"),o=o.removeQuery("e");else{const i=r.getFilename(e),s=t.URI.parse(e.href).getQuery();o=o.updateQuery({preview:i,t:null==s?void 0:s.t,e:null==s?void 0:s.e})}const a=o.getQuery();i?c.DBHistory.push_state(n,a,{immediatelyRestoreState:!1}):c.DBHistory.replace_state(n,a)}renderSDKSurface(){const{fileViewOrigin:e,hidePageChrome:n,transparentBackground:a,forceNoToolbar:c,user:_,browseContext:p,browseExceptions:h,canRestoreRevision:f,onRestoreRevision:v,onFullscreenChange:w,brandingInfo:m,initialPreviewSourceContext:g,shouldFocusApproval:S,shouldFocusComment:F,activeCommentThreadId:O,appDownloadInterstitialDismissed:T,containerId:I,isInsideBackup:E,previewApiDataMap:C,ajaxTimerName:x,updateFiles:P,encryptionOptions:R,editActivationParams:y}=this.props,{collection:b,currentIndex:V}=this.state,N=i.get(b.sharedLinkInfos,V),k=i.get(b.sharePermissions,V),D=i.get(b.shareTokens,V),L=i.get(b.files,V),j=b.files.map((e=>{var i;const t=r.getFileRevisionId(e);return null===(i=C[t])||void 0===i?void 0:i.data})),A=P?()=>P(b.files,L,!0):void 0;let H=null!=g?g:d.SourceContext.Unknown;switch(e){case s.FileViewOriginType.BROWSE:case s.FileViewOriginType.VERSION_HISTORY:case s.FileViewOriginType.HOME:case s.FileViewOriginType.HELLOSIGN:case s.FileViewOriginType.PHOTOS:case s.FileViewOriginType.STARRED:case s.FileViewOriginType.RECENTS:case s.FileViewOriginType.SEARCH:case s.FileViewOriginType.COLLECTIONS:case s.FileViewOriginType.VIDEO_SYNTHESIS:case s.FileViewOriginType.VIDEO_HOME:if(!_)throw new Error("User is required to browse files");let i;switch(e){case s.FileViewOriginType.VERSION_HISTORY:i=u.SDKPreviewSurface.VERSION_HISTORY;break;case s.FileViewOriginType.HOME:i=u.SDKPreviewSurface.HOME;break;case s.FileViewOriginType.HELLOSIGN:i=u.SDKPreviewSurface.HELLOSIGN;break;case s.FileViewOriginType.STARRED:i=u.SDKPreviewSurface.STARRED;break;case s.FileViewOriginType.RECENTS:i=u.SDKPreviewSurface.RECENTS;break;case s.FileViewOriginType.SEARCH:i=u.SDKPreviewSurface.SEARCH;break;case s.FileViewOriginType.PHOTOS:i=u.SDKPreviewSurface.PHOTOS;break;case s.FileViewOriginType.COLLECTIONS:i=u.SDKPreviewSurface.COLLECTIONS;break;case s.FileViewOriginType.VIDEO_SYNTHESIS:i=u.SDKPreviewSurface.VIDEO_SYNTHESIS;break;case s.FileViewOriginType.VIDEO_HOME:i=u.SDKPreviewSurface.VIDEO_HOME;break;default:i=u.SDKPreviewSurface.BROWSE}return(E||s.isBackupBrowse())&&(i=u.SDKPreviewSurface.BACKUP,H=d.SourceContext.Backup),t.React$1.createElement(t.React$1.Fragment,null,t.React$1.createElement(o.FileViewerWithCSS,{file:L,fileIndex:V,previewCollection:j,updateFiles:A,fileCount:b.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:N,sharePermission:k,shareToken:D,brandingInfo:m,user:_,onFileChanged:this.onFileChanged,closeFile:this.closeViewer,previewSurface:i,canRestoreRevision:f,onRestoreRevision:v,onFullscreenChange:w,browseContext:p,browseExceptions:h,previewContentOnly:n,canShowFileFlippers:i===u.SDKPreviewSurface.SEARCH||i===u.SDKPreviewSurface.BROWSE||i===u.SDKPreviewSurface.COLLECTIONS||i===u.SDKPreviewSurface.PHOTOS||i===u.SDKPreviewSurface.VIDEO_SYNTHESIS||i===u.SDKPreviewSurface.VIDEO_HOME,shouldFocusApproval:S,shouldFocusComment:F,activeCommentThreadId:O,hideOpenInAppInterstitial:!!T,fileViewOrigin:e,sourceContext:H,ajaxTimerName:x,encryptionOptions:R,editActivationParams:y}));case s.FileViewOriginType.SHARED_LINK_PAGE:if(!N||!k||!D)throw new Error("Missing required data to view");return t.React$1.createElement(t.React$1.Fragment,null,t.React$1.createElement(o.FileViewerWithCSS,{file:L,fileIndex:V,fileCount:b.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:N,sharePermission:k,shareToken:D,brandingInfo:m,closeFile:this.closeViewer,previewSurface:u.SDKPreviewSurface.SHARED_LINK,user:_,canShowFileFlippers:g===d.SourceContext.SharedLinkFolder||g===d.SourceContext.SharedLinkCollection,previewContentOnly:n,hideOpenInAppInterstitial:!!T,initialSourceAction:this.props.initialPreviewSourceAction,onFullscreenChange:w,fileViewOrigin:e,sourceContext:H,ajaxTimerName:x,encryptionOptions:R}));case s.FileViewOriginType.SHARED_CONTENT_LINK_PAGE:if(!N||!k||!D)throw new Error("Missing required data to view");return t.React$1.createElement(t.React$1.Fragment,null,t.React$1.createElement(o.FileViewerWithCSS,{file:L,fileIndex:V,fileCount:b.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:N,sharePermission:k,shareToken:D,brandingInfo:m,closeFile:this.closeViewer,previewSurface:u.SDKPreviewSurface.SHARED_CONTENT_LINK,user:_,canShowFileFlippers:!0,previewContentOnly:n,hideOpenInAppInterstitial:!!T,initialSourceAction:this.props.initialPreviewSourceAction,onFullscreenChange:w,fileViewOrigin:e,sourceContext:H,ajaxTimerName:x,encryptionOptions:R}));case s.FileViewOriginType.COMMERCE:case s.FileViewOriginType.TRANSFER:case s.FileViewOriginType.CLIENT_PORTAL:let r;switch(e){case s.FileViewOriginType.TRANSFER:r=u.SDKPreviewSurface.TRANSFER;break;case s.FileViewOriginType.CLIENT_PORTAL:r=u.SDKPreviewSurface.CLIENT_PORTAL;break;default:r=u.SDKPreviewSurface.COMMERCE}return t.React$1.createElement(o.FileViewerWithCSS,{file:L,fileIndex:V,fileCount:b.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:N,sharePermission:k,shareToken:D,brandingInfo:m,closeFile:this.closeViewer,previewSurface:r,user:_,canShowFileFlippers:!1,previewContentOnly:n,transparentBackground:a,forceNoToolbar:c,hideOpenInAppInterstitial:!!T,containerId:I,initialSourceAction:this.props.initialPreviewSourceAction,onPreviewSessionInitialized:this.props.onPreviewSessionInitialized,onFullscreenChange:w,fileViewOrigin:e,sourceContext:H,ajaxTimerName:x,encryptionOptions:R});case s.FileViewOriginType.SHARED_COLLECTION:return t.React$1.createElement(o.FileViewerWithCSS,{file:L,fileIndex:V,previewCollection:j,fileCount:b.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,user:_,onFileChanged:this.onFileChanged,closeFile:this.closeViewer,previewSurface:u.SDKPreviewSurface.SHARED_COLLECTION,canRestoreRevision:f,onRestoreRevision:v,onFullscreenChange:w,previewContentOnly:n,canShowFileFlippers:!0,hideOpenInAppInterstitial:!!T,fileViewOrigin:e,sourceContext:H,ajaxTimerName:x,encryptionOptions:R});default:return l.getMetricsReporter().createStats({ns:"web_previews",name:"unknown_preview_origin"},{origin:`${e}`}).record(1),t.React$1.createElement(o.FileViewerWithCSS,{file:L,fileIndex:V,fileCount:b.files.length,flipToNextFile:this.handleFlipNext,flipToPreviousFile:this.handleFlipPrevious,sharedLinkInfo:N,sharePermission:k,shareToken:D,brandingInfo:m,user:_,closeFile:this.closeViewer,previewSurface:u.SDKPreviewSurface.UNKNOWN,canRestoreRevision:f,onRestoreRevision:v,onFullscreenChange:w,previewContentOnly:n,canShowFileFlippers:!1,hideOpenInAppInterstitial:!!T,fileViewOrigin:e,sourceContext:H,ajaxTimerName:x,encryptionOptions:R})}}render(){return t.React$1.createElement("div",null,this.renderSDKSurface())}}Ai.displayName="_FileCollectionViewer";const Hi=s.connect(((e,i)=>({previewApiDataMap:n.getApiDataForFiles(e,i.files)})),{openFile:o.openFile})(Ai);class Ki extends t.React$1.Component{render(){return t.React$1.createElement(s.Provider,{store:Di},t.React$1.createElement(Hi,Object.assign({},this.props)))}}Ki.displayName="FileCollectionViewerWithProvider",e.FileCollectionViewer=Ki,e._FileCollectionViewer=Ai,e.getDerivedStateFromProps=ji}));
//# sourceMappingURL=c_file_viewer_collection_viewer.js-vfltBzIuf.map
