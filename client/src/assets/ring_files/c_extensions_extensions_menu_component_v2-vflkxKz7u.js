define(["exports","./c_tslib","./e_ui_page_files_router","./e_edison","./c_lodash-es_lodash","./c_spectrum_tooltip","./c_file_store_utils","./c_extensions_cloud_docs_compat","./c_extensions_extensions_utils","./c_core_browser_detection","./c_core_i18n"],(function(e,t,n,o,i,s,r,a,c,l,p){"use strict";class u extends o.React$1.Component{constructor(e){super(e),this.handleMouseOver=()=>{clearTimeout(this.timer),this.timer=setTimeout((()=>{this.props.bylines&&(this.setState({show:!0}),this.props.onDidShow())}),this.props.delay)},this.handleMouseOut=()=>{this.setState({show:!1}),clearTimeout(this.timer)},this.triggerRef=o.React$1.createRef(),this.state={show:!1}}componentWillUnmount(){clearTimeout(this.timer)}render(){const{children:e,bylines:t,isInActionBar:i}=this.props,s=o.React$1.Children.only(e);return t?o.React$1.createElement(o.React$1.Fragment,null,o.React$1.createElement(n.Tooltip.Control,{triggerRef:this.triggerRef,open:this.state.show,placement:i?"right":"left"},(e=>{if(e)return e.length>1?o.React$1.createElement("ul",{className:"extensions-byline-list"},e.map((e=>o.React$1.createElement("li",{key:e,className:"extensions-byline-list-item"},e)))):o.React$1.createElement("div",{className:"extensions-byline"},e[0])})(t)),o.React$1.cloneElement(s,{onMouseOver:this.handleMouseOver,onMouseOut:this.handleMouseOut,ref:this.triggerRef})):s}}u.defaultProps={delay:500},u.displayName="ExtensionsBylineTooltip";class d extends o.React$1.Component{render(){const{unityOptions:e,legacyCloudEditorOptions:t,cloudEditorAppActions:i,bylines:s,currentSession:r,previewOption:p,openInReplayOption:d,openInDesktopOption:h,isInActionBar:m,goToFolderOption:g,wrapValuesForActionBar:y,openInNewTabOption:f}=this.props,A=e=>y?c.toActionBarValue(e):e,E=t.map((e=>{const{type:t}=e,i=t===a.OpenButtonAction.OPEN_WITH_CLOUD_DOC?"cloud_doc":"wopi";return o.React$1.createElement(n.Menu.ActionItem,{key:e.text,value:A(e),withLeftAccessory:e.spriteName?o.React$1.createElement(n.Sprite,{group:"web",name:e.spriteName,alt:""}):o.React$1.createElement("img",{alt:"",src:e.iconUrl,width:24,height:24})},o.React$1.createElement(u,{isInActionBar:m,bylines:s[i],onDidShow:a.handleShowByline(i,r),key:e.text},o.React$1.createElement("span",null,e.text)))})),_=e.map((e=>o.React$1.createElement(n.Menu.ActionItem,{key:e.text,value:A(e),withLeftAccessory:function(e){return"ow_desktop"===e.spriteName&&e.type===a.OpenButtonAction.UNITY_FILE?-1!==e.text.indexOf("Dropbox")?o.React$1.createElement(n.UIIcon,{src:n.DropboxLine}):o.React$1.createElement(n.UIIcon,{src:n.OpenLine}):o.React$1.createElement(n.Sprite,{group:"web",name:e.spriteName||"",alt:""})}(e)},e.text)));let w=!1;const I=i.map((e=>{w||(w=a.isWopiAction(e.appAction));const t=e.appAction.handler.editor_name;return o.React$1.createElement(n.Menu.ActionItem,{key:e.appAction.description,value:A(e),withLeftAccessory:o.React$1.createElement("img",{alt:"",src:e.appAction.icon.url,width:24,height:24})},o.React$1.createElement(u,{isInActionBar:m,bylines:s[t],onDidShow:a.handleShowByline(t,r),key:e.appAction.description},o.React$1.createElement("span",null,e.appAction.description)))})),O=p&&o.React$1.createElement(n.Menu.ActionItem,{key:p.text,value:A(p),withLeftAccessory:o.React$1.createElement(n.UIIcon,{src:n.ShowLine})},p.text),b=d&&o.React$1.createElement(n.Menu.ActionItem,{key:d.text,value:A(d),withLeftAccessory:o.React$1.createElement(n.UIIcon,{src:n.DropboxReplayLine})},d.text),R=h&&o.React$1.createElement(n.Menu.ActionItem,{key:h.text,value:A(h),withLeftAccessory:o.React$1.createElement(n.UIIcon,{src:l.mac?n.FinderLine:n.FileExplorerLine})},h.text),x=f&&o.React$1.createElement(n.Menu.ActionItem,{key:f.text,value:A(f),withLeftAccessory:o.React$1.createElement(n.UIIcon,{src:n.GlobeLine})},f.text),C=g&&o.React$1.createElement(n.Menu.ActionItem,{key:g.text,value:A(g),withLeftAccessory:o.React$1.createElement(n.UIIcon,{src:n.FolderShowLine})},g.text),$=_.length>0||E.length>0||I.length>0||!!x||!!O||!!b||!!R||!!C;return w?$&&o.React$1.createElement(n.Menu.Segment,{key:"open-options"},x,C,I,_,E,O,b,R):$&&o.React$1.createElement(n.Menu.Segment,{key:"open-options"},x,C,_,E,I,O,b,R)}}d.displayName="UnityAndCloudEditorsComponent";const h=n.requireCssWithComponent(d,["/static/metaserver/static/css/app_actions/index-vflnoIMoQ.css","/static/metaserver/static/css/dig-components/index.web-vflGcQt8W.css"]);class m extends o.React$1.Component{constructor(e){super(e),this.createActionClickHandler=e=>()=>{if("cloud_editor"===e.handler[".tag"]){const t=a.isWopiAction(e)?a.OpenButtonAction.OPEN_WITH:a.OpenButtonAction.OPEN_WITH_CLOUD_DOC;a.logEvent(this.props.currentSession,"select_legacy_action",{type:t});const o=n.UserActionSourceType.WEB_PREVIEW,i=a.cloudEditorNameToParams(e.handler.editor_name);n.openWithCloudEditor(n.fileToOpenWithParams(this.props.file),this.props.user.id,i,!1,o)}}}render(){if(0===this.props.openOptions.length&&0===this.props.cloudEditorAppActions.length)return null;const e=this.props.cloudEditorAppActions.map((e=>({appAction:e,handler:this.createActionClickHandler(e),userAction:n.UserAction.OpenWithAppAction,actionName:e.description})));return o.React$1.createElement(h,{unityOptions:[],legacyCloudEditorOptions:this.props.openOptions,cloudEditorAppActions:e,bylines:{},wrapValuesForActionBar:!!this.props.isInActionBar})}}m.displayName="SharedFilePopoverContentComponent";const g=n.requireCssWithComponent(m,["/static/metaserver/static/css/app_actions/index-vflnoIMoQ.css"]);class y extends o.React$1.Component{constructor(e){super(e),this.createAppActionClickHandler=e=>()=>{var t,n;const{file:o,user:i,featureFlags:s,telemetryContext:r,updateLinkState:l}=this.props;if(c.redirectToActionOrShowAuth(i,[o],e,s,r,l),"redirect"===e.handler[".tag"]){const t=a.getAppActionExtras(e);a.logEvent(this.props.currentSession,"select_action",Object.assign({menu_version:2},t))}else if("cloud_editor"===e.handler[".tag"]){const t=a.isWopiAction(e)?a.OpenButtonAction.OPEN_WITH:a.OpenButtonAction.OPEN_WITH_CLOUD_DOC;a.logEvent(this.props.currentSession,"select_legacy_action",{type:t})}null===(n=(t=this.props).onExtensionClick)||void 0===n||n.call(t)},this.wrapperForAction=e=>({appAction:e,handler:this.createAppActionClickHandler(e),userAction:n.UserAction.OpenWithAppAction,actionName:e.description}),this.renderActionRow=e=>{const t=e.icon;let i;i=t.is_static?o.static_url("/static/metaserver/static/images/generic_app_icon-vflIPYT1H.png"):t.url;const s=e.description,r=this.props.isInActionBar?c.toActionBarValue(this.wrapperForAction(e)):this.wrapperForAction(e);return o.React$1.createElement(n.Menu.ActionItem,{key:e.id,value:r,withLeftAccessory:o.React$1.createElement("img",{alt:"",src:i,width:24,height:24})},s)},this.renderUnpromotedActions=(e,t)=>{const{user:i,file:s,categoryIdToInfos:r,featureFlags:l,currentSession:u,telemetryContext:d,updateLinkState:h,isInActionBar:m}=this.props,g=e.length>0,y={handler:()=>{const n=[...e,...t];c.showExtensionsMiniDirectoryModal(p.intl.formatMessage({id:"KVD2SP",defaultMessage:"Open or edit with these apps"}),i,s,n,r,l,h,d,u),a.logEvent(u,g?"select_show_more":"select_add_app",{surface:d&&d.surface})}},f=m?c.toActionBarValue(y):y;return o.React$1.createElement(n.Menu.ActionItem,{key:p.intl.formatMessage({id:"R/67N/",defaultMessage:"Show more"}),value:f,withLeftAccessory:g&&!m?null:o.React$1.createElement(n.UIIcon,{src:n.AddCircleLine})},g?p.intl.formatMessage({id:"Gevpqz",defaultMessage:"Connect more apps"}):p.intl.formatMessage({id:"XFA09U",defaultMessage:"Connect apps"}))}}render(){const{appActions:e,openOptions:t,bylines:i,currentSession:s,isInActionBar:r}=this.props,c=a.getOpenOptionsWithLogging(t,s),{unityOptions:l,cloudEditorOptions:p,previewOption:u,openInReplayOption:d,openInDesktopOption:m,goToFolderOption:g,openInNewTabOption:y}=a.partitionOptions(c),{cloudEditors:f,installedActions:A,unpromotedActions:E}=a.partitionActions(e),_=A.length>0,w=E.length>0;return o.React$1.createElement(o.React$1.Fragment,null,o.React$1.createElement(h,{isInActionBar:r,unityOptions:l,legacyCloudEditorOptions:p,cloudEditorAppActions:f.map((e=>this.wrapperForAction(e))),bylines:i,currentSession:s,previewOption:u,openInReplayOption:d,openInNewTabOption:y,openInDesktopOption:m,goToFolderOption:g,wrapValuesForActionBar:!!r}),r&&(_||w)&&o.React$1.createElement(n.Menu.Segment,null,A.map((e=>this.renderActionRow(e))),this.renderUnpromotedActions(A,E)),!r&&_&&o.React$1.createElement(n.Menu.Segment,{key:"installed-actions"},A.map((e=>this.renderActionRow(e)))),!r&&w&&o.React$1.createElement(n.Menu.Segment,null,this.renderUnpromotedActions(A,E)))}}y.displayName="ExtensionsPopoverV2Component";const f=n.requireCssWithComponent(y,["/static/metaserver/static/css/app_actions/index-vflnoIMoQ.css"]);class A extends o.React$1.Component{constructor(){super(...arguments),this.mounted=!1,this.state={unityInfo:null}}componentDidMount(){this.mounted=!0,c.UnityHelpers.isUnityEnabled()&&this.setupUnity()}componentWillUnmount(){this.mounted=!1,window.clearTimeout(this.disableCheck)}setupUnity(){this.props.isUnityDisabled?this.disableUnity():(c.UnityHelpers.getUnityFileInfo(this.props.file.ns_id,this.props.file.ns_path,this.props.user.id,(e=>{this.mounted&&this.setState({unityInfo:e})}),(()=>{this.mounted&&this.disableUnity()})),this.disableCheck=window.setTimeout((()=>{this.state.unityInfo||this.disableUnity()}),1e4))}disableUnity(){this.setState({unityInfo:{local_path:null,resolved_local_path:null,can_open_directly:!1,is_locally_available:!1,is_infinite_placeholder:!1,open_application_identifier:null,open_application_name:null,path_is_dir:!1,error_message:null}})}render(){return this.props.render(this.state.unityInfo)}}A.displayName="WithUnity";class E extends o.React$1.Component{constructor(e){super(e),this.handleButtonClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleMenuClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleHover=()=>{this.currentSession&&this.currentSession.event("trigger_hover")},this.setBigTooltip=e=>t.__awaiter(this,void 0,void 0,(function*(){const{file:t,appActions:o,featureFlags:i}=this.props,s=a.getFileExt(t)||"",r=o.length>0;if(r){const t=yield n.getTooltipHistory(e,["open_with_edu"]),o=n.allowedTooltips(r,s,i).find((e=>void 0!==t[e]&&!t[e]));this.setState({bigTooltipName:o})}})),this.markBigTooltipViewed=()=>{let e=!1;const t=[];this.state.bigTooltipName&&(t.push(n.markTooltipViewed(this.props.user.id,this.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then((()=>{this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)})),this.setState({bigTooltipName:void 0}))},this.handleSelectAction=(e,t)=>{t.preventDefault(),e.handler(),this.props.onExtensionClick&&this.props.onExtensionClick(e.actionName||e.userAction),this.logToPreviews(e,!1),t.stopPropagation()},this.logToPreviews=(e,t)=>{this.props.telemetryContext&&"previews"===this.props.telemetryContext.surface&&e.userAction&&(!e.actionName||e.actionName,r.isBrowseFile(this.props.file)&&this.props.file.read_only)},this.renderTrigger=e=>{const{triggerType:t}=this.props,r=Object.assign({onMouseDown:this.markBigTooltipViewed,onMouseEnter:this.handleHover},e),a="app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",c=p.intl.formatMessage({id:"z5t3Bh",defaultMessage:"Open"}),l=i.uniqueId("app-action-open-with-menu-");return t===n.TriggerType.OpacityButton?o.React$1.createElement(n.Button$1,Object.assign({id:l,variant:"opacity",withDropdownIcon:!0},r,{"aria-labelledby":n.cx(l,this.props.arialabelledby)}),c):t===n.TriggerType.CollapsedButton?o.React$1.createElement(s.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:p.intl.formatMessage({id:"KEegJt",defaultMessage:"Open With"})},o.React$1.createElement(n.IconButton,Object.assign({id:l,variant:"transparent",className:a,"aria-label":c,"aria-labelledby":n.cx(l,this.props.arialabelledby)},r),o.React$1.createElement(n.UIIcon,{src:n.OpenLine}))):o.React$1.createElement(n.Button$1,Object.assign({id:l,className:a,variant:t&&t!==n.TriggerType.SecondaryButton?"primary":"opacity","aria-label":c,"aria-labelledby":n.cx(l,this.props.arialabelledby)},r),o.React$1.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},o.React$1.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},`${c} â–¾`)))},this.renderMenu=()=>o.React$1.createElement(n.Menu.Wrapper,{className:"app-actions__unportaled-menu",onSelection:this.handleSelectAction,onToggle:this.onPopoverToggle,isPortaled:!0},(({getContentProps:e,getTriggerProps:t})=>o.React$1.createElement(o.React$1.Fragment,null,this.renderTrigger(t({onClick:this.handleButtonClick})),o.React$1.createElement(n.Menu.Content,Object.assign({},e({}),{onClick:this.handleMenuClick,className:"app-actions-open-with-menu",placement:"bottom-end"}),o.React$1.createElement(R,{user:this.props.user,file:this.props.file,arialabelledby:this.props.arialabelledby,unityInfo:this.props.unityInfo,extraOptions:this.props.extraOptions,currentSession:this.currentSession,telemetryContext:this.props.telemetryContext}))))),this.onPopoverToggle=({isOpen:e})=>{e&&this.props.onDropdownOpen?this.props.onDropdownOpen():!e&&this.props.onDropdownClose&&this.props.onDropdownClose(),this.currentSession&&this.currentSession.event(e?"open_popover":"close_popover")},this.onDownloadClick=e=>t=>{t.preventDefault(),t.stopPropagation(),e.handler(),this.logToPreviews(e,!0)},this.state={},this.telemetryClient=c.createTelemetryClient({component:"menu_v2"})}componentDidMount(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)}render(){const{file:e,appActions:t,featureFlags:s,telemetryContext:l,triggerType:u,showAsButtonIfDownloadOnly:d,unityInfo:h,extraOptions:m,user:g,cloudDocsInfo:y}=this.props;if(!e.file_id)return null;l?this.currentSession=this.telemetryClient.session({surface:l.surface,ext:c.getPiiSafeExtension(a.getFileExt(e)||""),feature_flags:s}):delete this.currentSession;const f=c.getOpenOptionsForFile({file:e,unityInfo:h,extraOptions:m,user:g,isCloudEditorDisabled:!0,cloudDocsInfo:y,surface:null==l?void 0:l.surface}),A=u===n.TriggerType.CollapsedButton;let E=f.length>0,_=!1;if(E&&1===f.length&&(_=f[0].type===a.OpenButtonAction.DOWNLOAD,E=!_),!E&&(0===t.length||r.isSharedFile(e)&&0===a.partitionActions(t).cloudEditors.length)){if(d&&_){const e={className:n.cx("app-actions-download-button",{"app-actions-download-button--collapsed":A}),onClick:this.onDownloadClick(f[0])},t=i.uniqueId("app-actions-download-button-");return A?o.React$1.createElement(n.IconButton,Object.assign({id:t,variant:"transparent","aria-labelledby":n.cx(t,this.props.arialabelledby)},e),o.React$1.createElement(n.UIIcon,{name:"download-file",src:n.DownloadLine,"aria-label":p.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"})})):o.React$1.createElement(n.Button$1,Object.assign({id:t,variant:"opacity","aria-labelledby":n.cx(t,this.props.arialabelledby)},e),p.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"}))}return null}return this.renderMenu()}}E.displayName="ExtensionsMenuV2Component";const _={updateLinkState:(e,t)=>n.updateLinkState({actionId:e,linkState:t})},w=n.connect(((e,t)=>({appActions:a.getOpenActionsForFile(e,t.file),bylines:a.getBylines(e),categoryInfos:a.getCategoryInfos(e),featureFlags:a.getFeatureFlags(e),cloudDocsInfo:a.getCloudDocInfo(e)})),_),I=w((e=>r.isBrowseFile(e.file)?o.React$1.createElement(A,{file:e.file,user:e.user,render:t=>o.React$1.createElement(E,Object.assign({},e,{unityInfo:t}))}):o.React$1.createElement(E,Object.assign({},e)))),O=n.requireCssWithComponent(I,["/static/metaserver/static/css/app_actions/index-vflnoIMoQ.css","/static/metaserver/static/css/dig-components/index.web-vflGcQt8W.css"]),b=e=>{const{file:t,user:n,telemetryContext:i,appActions:s,bylines:l,categoryInfos:p,featureFlags:u,updateLinkState:d,unityInfo:h,extraOptions:m,cloudDocsInfo:y,isInActionBar:A,previewActionHandler:E,openDesktopActionHandler:_,goToFolderActionHandler:w,replayActionHandler:I,openInNewTabActionHandler:O,onExtensionClick:b}=e,R=c.getCategoryIdToInfos(p),x=c.getOpenOptionsForFile({file:t,unityInfo:h,extraOptions:m,user:n,isCloudEditorDisabled:!0,cloudDocsInfo:y,surface:null==i?void 0:i.surface,isInActionBar:A,previewActionHandler:E,openDesktopActionHandler:_,goToFolderActionHandler:w,replayActionHandler:I,openInNewTabActionHandler:O}),C=i&&(e.currentSession||c.createTelemetryClient({component:"menu_v2"}).session({surface:i.surface,ext:c.getPiiSafeExtension(a.getFileExt(t)||""),feature_flags:u}));if(r.isBrowseFile(t)&&(s.length>0||x.length>0))return o.React$1.createElement(f,{file:t,user:n,openOptions:x,appActions:s,bylines:l,categoryIdToInfos:R,featureFlags:u,updateLinkState:d,telemetryContext:i,currentSession:C,isInActionBar:A,onExtensionClick:b});if(r.isSharedFile(t)){const{cloudEditors:e}=a.partitionActions(s);return o.React$1.createElement(g,{openOptions:x,cloudEditorAppActions:e,file:t,user:n,currentSession:C,isInActionBar:A})}return null};b.displayName="ExtensionsPopoverContentController";const R=w(b);e.ExtensionsMenuV2=O,e.ExtensionsPopoverContent=R,e.WithUnity=A}));
//# sourceMappingURL=c_extensions_extensions_menu_component_v2.js-vflo4Lael.map
