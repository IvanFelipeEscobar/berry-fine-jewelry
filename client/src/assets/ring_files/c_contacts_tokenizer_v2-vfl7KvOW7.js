define(["exports","./c_tslib","./e_edison","./e_ui_page_files_router","./c_core_i18n","./c_typeahead_index","./c_contacts_data_v2","./c_contacts_contact_token_state","./c_profile_services_profile_services_link","./c_profile_services_profile_services_constants"],(function(e,t,a,n,c,r,o,s,i,l){"use strict";const u=({contact:e,size:t})=>{const c=e.name||e.email||"";let r=e.photo_url;e.type===n.ContactTypes.FB&&(r=`https://graph.facebook.com/${e.fb_id}/picture`);let o=n.getInitials(c);return r?a.React$1.createElement(n.Avatar,{size:t,src:r}):a.React$1.createElement(n.Avatar,{size:t,backgroundColor:n.avatarColorForUserIdentifier(o)},o)};u.displayName="ContactAvatar";const m={type:"expand",getKey:()=>"expand-importer"},d=({contact:e,contactValidator:t,onDelete:c})=>{var r;const o=null==t?void 0:t(e),i={size:"small",onDelete:c,withIconLeft:e.photo_url?a.React$1.createElement(n.Avatar,{hasNoOutline:!0,size:"small",src:e.photo_url}):void 0,children:null!==(r=e.name)&&void 0!==r?r:e.email},l=(null==o?void 0:o.state)===s.ContactTokenState.warn?a.React$1.createElement(n.InputChip,Object.assign({},i,{isWarning:!0})):(null==o?void 0:o.state)===s.ContactTokenState.invalid?a.React$1.createElement(n.InputChip,Object.assign({},i,{isAlert:!0})):a.React$1.createElement(n.InputChip,Object.assign({},i));return(null==o?void 0:o.msg)?a.React$1.createElement(n.Tooltip,{title:o.msg},l):l};d.displayName="ContactChip";const p=([e,t])=>e+t,g=({string:e,match:t})=>{if(!t||0===t.highlighted.length)return a.React$1.createElement(n.Text,null,e);const c=t.highlighted;return a.React$1.createElement(a.React$1.Fragment,null,c.map(((t,r)=>{const o=0===r?[0,0]:c[r-1];return a.React$1.createElement(a.React$1.Fragment,{key:r},a.React$1.createElement(n.Text,null,e.slice(p(o),t[0])),a.React$1.createElement(n.Text,{isBold:!0},e.slice(t[0],p(t))))})),e.slice(p(c[c.length-1])))};g.displayName="MatchedString";const h=({contact:e})=>{const t=c.useIntl(),o={key:e.getKey(),value:e};return"expand"===e.type?a.React$1.createElement(r.Typeahead.Row,Object.assign({},o,{withTitle:t.formatMessage({id:"otWq6d",defaultMessage:"Import contacts"}),withLeftAccessory:a.React$1.createElement(n.UIIcon,{src:n.ImportContactsLine})})):"third-party"===e.type?a.React$1.createElement(r.Typeahead.Row,Object.assign({},o,{withTitle:l.ProfileServicesConstants.to_name(e.provider),withSubtitle:e.connected?t.formatMessage({id:"abwbjF",defaultMessage:"Connected"}):void 0,withLeftAccessory:a.React$1.createElement(n.UIIcon,{src:n.GoogleExternalLogo})})):a.React$1.createElement(r.Typeahead.Row,Object.assign({},o,{withTitle:a.React$1.createElement(g,{string:e.name,match:e.nameMatch}),withSubtitle:e.email&&a.React$1.createElement(g,{string:e.email,match:e.emailMatch}),withLeftAccessory:a.React$1.createElement(u,{contact:e})}))};h.displayName="ContactSuggestion";const R=e=>e.email||e.getKey(),f=e=>a.React$1.createElement(h,{contact:e}),$=(e,t)=>{let a=!1;const n=e.map((e=>{var n;if(!e.pending||!e.query)return e;const c=o.ContactsDataSourceV2.normalizeQuery(e.query),r=null===(n=t[c])||void 0===n?void 0:n.find((t=>t.email===e.email));return a=a||!!r,null!=r?r:e}));return a?n:e},_=new i.ProfileServicesLinkingHandler,y=e=>{var{user:s,contactFilter:u,initialContacts:p,onContentsChange:g,contactValidator:h,onQueryChange:y,focusOnMount:v,showContactImport:C,maxContacts:E,contactsDataSourceFactory:k,resetTokenData:b}=e,T=t.__rest(e,["user","contactFilter","initialContacts","onContentsChange","contactValidator","onQueryChange","focusOnMount","showContactImport","maxContacts","contactsDataSourceFactory","resetTokenData"]);const I=a.React$1.useRef(null),S=a.React$1.useRef(null),[w,x]=a.React$1.useState([]),[M,O]=a.React$1.useState(null!=p?p:[]),[F,L]=a.React$1.useState(!1),[A,D]=a.React$1.useState(""),P=a.React$1.useRef(A),j=c.useIntl(),z=a.React$1.useMemo((()=>k?k(s,u):new o.ContactsDataSourceV2(s,u)),[s,u]),K=a.React$1.useMemo((()=>C&&s?i.LinkedProfileServices.get_linked_profile_services_for_user(s.id):void 0),[C,s]);a.React$1.useEffect((()=>null==g?void 0:g(M)),[M]),a.React$1.useEffect((()=>{null==y||y(A),P.current=A}),[A]),a.React$1.useEffect((()=>{var e;v&&(null===(e=S.current)||void 0===e||e.focus())}),[]),a.React$1.useEffect((()=>{b&&M.length>0&&V([])}),[b]);const V=a.React$1.useCallback(((e,t="")=>{O(e),D(t)}),[]),N=a.React$1.useCallback(((e,t)=>V((t=>t.concat(e.split(/[, ]/).map((e=>e.trim())).filter((e=>!!e)).map(n.Contact.buildFromRawEmail))),t)),[V]);a.React$1.useEffect((()=>{const e=(e=>{const t=new Set(e.map(R));return e=>e.filter((e=>!t.has(R(e))))})(M);z.search(A,(t=>x(e(t))),(t=>{P.current===A&&x((a=>a.concat(e(t))))}))}),[z,M,A]),a.React$1.useEffect((()=>{const e=M.reduce(((e,t)=>t.pending&&t.query?[...e,t.query]:e),[]);0!==e.length&&z.searchBatch(e,(e=>O((t=>$(t,e)))),(e=>O((t=>$(t,e)))))}),[M,z]);const q=a.React$1.useCallback((e=>{var t;"expand"===e.type?(L(!0),null===(t=S.current)||void 0===t||t.focus()):"third-party"===e.type?(((e,t,a)=>{if(t){if(!a.connected)return _.auth_service_with_user(a.provider,t.id,i.ProfileServicesLinkingHandler.show_import_notifications);{const t=e.formatMessage({id:"6kb+zR",defaultMessage:"You're already connected to {service_name}"},{service_name:l.ProfileServicesConstants.to_name(a.provider)});n.Snackbar.fail(t)}}})(j,s,e),L(!1)):V((t=>t.concat(e)))}),[V,j,s]),U=a.React$1.useCallback((e=>V((t=>t.filter((t=>t.name!==e.name&&t.email!==e.email))))),[V]),B=a.React$1.useCallback((e=>{const t=e.currentTarget.value,a=Math.max(t.lastIndexOf(","),t.lastIndexOf(" "));if(a>0){const e=a+1,n=t.slice(0,e),c=e<t.length?t.slice(e):"";N(n,c)}else D(t)}),[N]),Q=a.React$1.useCallback((e=>{e.key===n.Key_enum.Key.Backspace&&""===A&&M.length>0?(V((e=>e.slice(0,-1))),e.stopPropagation()):e.key!==n.Key_enum.Key.Enter&&" "!==e.key||""===A||(N(A),e.stopPropagation())}),[N,V,A,M.length]),W=F&&K?(e=>l.ProfileServicesConstants.importable_contact_services().map((t=>((e,t)=>({type:"third-party",provider:e,connected:t,getKey:()=>`third-party-import-${e}`}))(t,null==e?void 0:e.service_is_connected(t)))))(K):(null==K?void 0:K.has_unconnected_services(!0))?[...w,m]:w;return a.React$1.createElement(r.Typeahead.Wrapper,{onSelection:q,closeOnSelection:!1},(({getTriggerProps:e,getContentProps:t})=>a.React$1.createElement(a.React$1.Fragment,null,a.React$1.createElement(n.TextInput.Container,{ref:I},a.React$1.createElement(n.TextInput.Accessory,null,a.React$1.createElement(n.UIIcon,{src:n.SearchLine,role:"presentation"})),a.React$1.createElement(n.TextInput.ChipsContainer,null,!!M.length&&M.map(((e,t)=>a.React$1.createElement(d,{key:t,contact:e,onDelete:()=>U(e),contactValidator:h}))),(void 0===E||M.length<E)&&a.React$1.createElement(n.TextInput.Input,Object.assign({"aria-label":j.formatMessage({id:"sZaLAU",defaultMessage:"Contact input"})},T,{ref:S,value:A},e({onChange:B,onKeyDown:Q}))))),a.React$1.createElement(r.Typeahead.Container,Object.assign({},t(),{triggerRef:I}),a.React$1.createElement(r.Typeahead.Results,{results:W,renderRow:f})))))};y.displayName="ContactsTokenizerV2",e.ContactsTokenizerV2=y}));
//# sourceMappingURL=c_contacts_tokenizer_v2.js-vflgxEwhP.map
