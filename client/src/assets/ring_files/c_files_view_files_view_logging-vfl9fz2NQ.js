define(["require","exports","./c_tslib","./c_lodash-es_lodash","./e_ui_page_files_router","./c_files_view_file_actions_file_from_metadata","./c_file_actions_strings","./c_src_sink_index","./c_action_bar_file_actions_logging","./c_files_view_file_actions_snackbars","./c_core_i18n"],(function(e,t,s,r,n,i,a,o,l,c,u){"use strict";const _=({state:e,eventName:t,num_files_selected:s,num_folders_selected:r,batch_success_count:i,batch_fail_count:a,lookup_error_type:o,error_summary:l})=>{n.logFileAction({uid:n.user(e).id,action:t,num_files_selected:s,num_folders_selected:r,view_type:n.selectViewType(e,{instanceId:n.SEARCH_FILES_VIEW_ID}),batch_success_count:i,batch_fail_count:a,lookup_error_type:o,error_summary:l})},d=(e,t,s)=>r.compact(s.toArray().map((s=>{if(n.isFile(s)&&t.includes(s.fq_path))return new n.File(Object.assign(Object.assign({},s),{isDeleted:e,thumbnail_url_tmpl:e?null:s.thumbnail_url_tmpl}))}))),m=(e,t)=>t.filter((t=>n.isFile(t)&&!e.has(t.file_id))),f=(e,t)=>t.map((t=>{if(n.isFile(t)){const s=!!e.get(t.fq_path);return new n.File(Object.assign(Object.assign({},t),{isDeleted:s,thumbnail_url_tmpl:s?null:t.thumbnail_url_tmpl}))}return t})),g=(e,t)=>r.compact(t.map((t=>{if(n.isFile(t)){const s=n.getIdForSearchResult(t),r=e.get(s);if(r)return new n.File(Object.assign(Object.assign({},t),Object.fromEntries(Object.entries(r).filter((([e,t])=>void 0!==t)))))}return t})));const h=({files:e,checkFSWs:t})=>function(m,f){return s.__awaiter(this,void 0,void 0,(function*(){const g=n.user(f()),S=n.context$1(f());yield function({files:e,user:t,context:r}){return s.__awaiter(this,void 0,void 0,(function*(){return new Promise((s=>{n.showDelete(t,e,r,"/",s)}))}))}({user:g,files:e,context:S});const p=o.getMetricsReporter(),b={surface:"search",batchSizeBucket:i.bucketForBatchSize(e.length),contentType:i.batchContentType(e)},E=p.createTimer({ns:i.FILE_ACTIONS_AMP_NAMESPACE,name:"delete/batch/latency_total_ms"},b),F=Date.now(),w=p.createStats({ns:i.FILE_ACTIONS_AMP_NAMESPACE,name:"delete/batch/latency_average_ms"},b),v=p.createStats({ns:i.FILE_ACTIONS_AMP_NAMESPACE,name:"delete/batch/completed"},b);n.Snackbar.sync(u.intl.formatMessage(a.deleteSnackbarProgressMessage,{count:e.length}),!0,"browse-action"),_({state:f(),eventName:n.WebUserActionLogEvent.DELETE_REQUEST_ATTEMPT,num_files_selected:e.length,num_folders_selected:0});const A=yield a.deleteFiles(e,g.id,t);if(A.isError&&"path"===A.error[".tag"]&&"file_system_warnings"===A.error.path[".tag"])return void m((({files:e,details:t})=>(r,i)=>s.__awaiter(void 0,void 0,void 0,(function*(){n.Snackbar.close("browse-action"),n.showFileSystemWarningsModal({fsws:t,onFinalAccept:()=>{r(h({files:e,checkFSWs:!1}))},confirmText:u.intl.formatMessage(a.deleteFswConfirmText)})})))({files:e,details:A.error.path.details}));if(E.record(),w.record((Date.now()-F)/e.length),A.isError)return m((({files:e,result:t})=>(r,i)=>s.__awaiter(void 0,void 0,void 0,(function*(){n.Snackbar.fail(c.deleteError(e.length,t.error),"browse-action");const{num_files_selected:s,num_folders_selected:r}=n.countFilesAndFolders(n.immutableExports.List(e));_({state:i(),eventName:n.WebUserActionLogEvent.DELETE_REQUEST_FAIL,num_files_selected:s,num_folders_selected:r,batch_success_count:0,batch_fail_count:e.length,error_summary:t.error_summary})})))({files:e,result:A})),void v.record(0);const y=A.result.entries.filter((e=>"success"===e[".tag"])),k=r.compact(y.map((e=>e.metadata.path_display)));n.shouldUseReactQueryForSearchView()?(m(n.updateReactQuerySearchResults({deletedFilePaths:k})),m(n.setSelection({selection:new n.Selection({selected:n.immutableExports.OrderedSet(k),anchor:null}),skipLogging:!0}))):m(n.updateResults({results:d(!0,k,n.results(f()))}));const M=()=>s.__awaiter(this,void 0,void 0,(function*(){n.Snackbar.close("browse-action"),_({state:f(),eventName:n.WebUserActionLogEvent.DELETE_UNDO,num_files_selected:A.result.changeset_data.length,num_folders_selected:0}),l.rollback({changeset_data:A.result.changeset_data,userId:g.id,onSuccess:()=>{n.Snackbar.complete(u.intl.formatMessage(a.deleteUndoSnackbarMessage),"browse-action"),_({state:f(),eventName:n.WebUserActionLogEvent.DELETE_UNDO_REQUEST_SUCCESS,num_files_selected:A.result.changeset_data.length,num_folders_selected:0}),n.shouldUseReactQueryForSearchView()?m(n.updateReactQuerySearchResults({restoredDeletedFilePaths:k})):m(n.updateResults({results:d(!1,k,n.results(f()))}))}})}));n.setHandleUndo(M);const R=A.result.entries.filter(a.isFailure),T=R[0];let P,L;if(void 0!==T){const e=T.failure;P=e[".tag"],a.isPathLookupFailure(e)&&(L=e.path_lookup[".tag"])}const U=A.result.entries.filter((e=>a.isFailure(e)&&!a.isPathLookupFailure(e.failure))).length;v.record(U>0?0:1),i.recordPathLookupErrors(R,"delete",b),R.length===A.result.entries.length?(n.Snackbar.fail(c.deleteCompleteError(R),"browse-action"),_({state:f(),eventName:n.WebUserActionLogEvent.DELETE_REQUEST_FAIL,num_files_selected:A.result.changeset_data.length,num_folders_selected:0,batch_success_count:A.result.entries.length-R.length,batch_fail_count:R.length,lookup_error_type:L,error_summary:P})):(n.Snackbar.completeWithUndo(c.deleteCompleteSuccess(e.length,y.length),M,"browse-action"),_({state:f(),eventName:n.WebUserActionLogEvent.DELETE_REQUEST_SUCCESS,num_files_selected:A.result.changeset_data.length,num_folders_selected:0,batch_success_count:A.result.entries.length,batch_fail_count:0,lookup_error_type:L,error_summary:P}))}))},S=({file:e,name:t,checkFSWs:r})=>function(l,_){return s.__awaiter(this,void 0,void 0,(function*(){const d=n.user(_()),m=o.getMetricsReporter(),f={surface:"browse",contentType:e.is_dir?"folders":"files"},g={latency:m.createTimer({ns:i.FILE_ACTIONS_AMP_NAMESPACE,name:"rename/latency_ms"},f),completed:m.createStats({ns:i.FILE_ACTIONS_AMP_NAMESPACE,name:"rename/completed"},f)};if(-1!==t.indexOf("/"))return n.Snackbar.fail(u.intl.formatMessage(a.renameErrorInvalidName),"browse-action"),void l(n.setFileRename({file:e,renameState:null}));l(n.setFileRename({file:e,renameState:n.RenameState.SAVING_INPUT})),n.Snackbar.sync(u.intl.formatMessage(a.renameSnackbarProgressMessage),!1,"browse-action");const h=yield a.renameFile(e.fq_path,t,d.id,{checkFSWs:r});if(h.isError&&"to"===h.error[".tag"]&&"file_system_warnings"===h.error.to[".tag"])return void l((({file:e,name:t,details:r})=>i=>s.__awaiter(void 0,void 0,void 0,(function*(){n.Snackbar.close("browse-action"),n.showFileSystemWarningsModal({fsws:r,onFinalAccept:()=>{i(S({file:e,name:t,checkFSWs:!1}))},onAbortAction:()=>{i(n.setFileRename({file:e,renameState:null}))},confirmText:u.intl.formatMessage(a.renameFswConfirmText)})})))({file:e,name:t,details:h.error.to.details}));if(g.latency.record(),h.isError||"success"!==h.result.entries[0][".tag"]){const t=h.isError?h:a.createUndefinedRpcResult();return l((({file:e,result:t})=>(r,i)=>s.__awaiter(void 0,void 0,void 0,(function*(){r(n.setFileRename({file:e,renameState:null})),n.Snackbar.fail(c.renameError(t.error,e.fq_path),"browse-action")})))({file:e,result:t})),void g.completed.record(0)}const p=h.result.entries[0],b=i.fileFromMetadata(e,p.success);n.shouldUseReactQueryForSearchView()?l(n.updateReactQuerySearchResults({movedOrRenamedFiles:[b]})):l(n.updateResults({results:[b]})),l(n.setSelection({selection:new n.Selection({selected:n.immutableExports.OrderedSet([b.fq_path]),anchor:null}),skipLogging:!0})),l(n.fileRename({file:e,newFile:b})),l(n.setFileRename({file:e,renameState:null})),g.completed.record(1);const E=()=>{l((({file:e,result:t})=>(r,l)=>s.__awaiter(void 0,void 0,void 0,(function*(){const s=n.user(l()),c=o.getMetricsReporter(),_={surface:"search",contentType:e.is_dir?"folders":"files",batchSizeBucket:"single"},d={latency:c.createTimer({ns:i.FILE_ACTIONS_AMP_NAMESPACE,name:"undo/latency_ms"},_),completed:c.createStats({ns:i.FILE_ACTIONS_AMP_NAMESPACE,name:"undo/completed"},_)};n.Snackbar.sync(u.intl.formatMessage(a.renameUndoSnackbarProgressMessage),!1,"browse-action"),(yield a.undo(t.result.changeset_data,s)).isError?(n.Snackbar.fail(u.intl.formatMessage(a.renameUndoSnackbarErrorMessage),"browse-action"),d.completed.record(0)):(n.Snackbar.complete(u.intl.formatMessage(a.renameUndoSnackbarSuccessMessage),"browse-action"),n.shouldUseReactQueryForSearchView()?r(n.updateReactQuerySearchResults({movedOrRenamedFiles:[e]})):r(n.updateResults({results:[e]})),r(n.setSelection({selection:new n.Selection({selected:n.immutableExports.OrderedSet([e.fq_path]),anchor:null}),skipLogging:!0})),d.completed.record(1)),d.latency.record()})))({file:e,result:h}))};n.setHandleUndo(E),n.Snackbar.completeWithUndo(u.intl.formatMessage(a.renameSnackbarSuccessMessage),E,"browse-action")}))};t.deleteFiles=h,t.logEvent=({user:t,action:r,extra:n})=>s.__awaiter(void 0,void 0,void 0,(function*(){(yield new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.action_logger_esnext}))).logWebUserAction({user_id:t.id,event_name:r,extra:n})})),t.logEventWithNumberOfFiles=t=>{const{isSearchMode:s,file:r,extra:i,action:a,action_source:o,action_surface:l,user:c,requestId:u,resultList:_,hasMoreResults:d}=t;if(s){const t=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.logger_esnext})),s=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.index_esnext})),c=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.store_esnext$1}));Promise.all([t,s,c]).then((([e,t,s])=>{const c=s.getStoreForSearch().getState(),m=t.selectedFiles(c),{num_files_selected:f,num_folders_selected:g}=n.countFilesAndFolders(m),h=Object.assign(Object.assign({},i),{num_files_selected:f.toString(),num_folders_selected:g.toString()});e.logResultAction(a,null!=_?_:n.immutableExports.List(),r,u,null!=d&&d,l,o,h)}))}else{const t=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.action_logger_esnext})),s=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.store_esnext$2})),u=new Promise((function(t,s){e(["./e_ui_page_files_router"],t,s)})).then((function(e){return e.Selectors$1}));Promise.all([t,s,u]).then((([{logBrowseAction:e},{getStoreForBrowse:t},s])=>{const u=s.selectedFiles(t().getState()),{num_files_selected:_,num_folders_selected:d}=n.countFilesAndFolders(u);e({uid:c.id,action:a,result:r,num_files_selected:_,num_folders_selected:d,action_surface:l,action_source:o,extra:i})}))}},t.renameFile=S,t.updateSearchResultsFromFileActions=(e,t)=>{let s=t;const{idToIsDeletedFileMap:r,idToMovedOrRenamedFileMap:n,purgedFileIds:i}=e;return(null==i?void 0:i.size)&&(s=m(i,s)),n&&(s=g(n,s)),r&&(s=f(r,s)),s}}));
//# sourceMappingURL=c_files_view_files_view_logging.js-vflSbwbPL.map
