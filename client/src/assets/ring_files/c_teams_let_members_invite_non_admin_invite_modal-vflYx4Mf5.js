define(["exports","./e_edison","./c_core_i18n","./e_ui_page_files_router","./c_core_notify","./c_contacts_contact_token_state","./c_contacts_tokenizer_v2","./c_tslib","./c_apex-metrics_src_types","./c_lodash-es_lodash","./e_core_exception","./c_core_exception_info","metaserver/static/js/modules/constants/page_load","metaserver/static/js/modules/constants/request","./c_src_sink_index","./c_core_browser_detection","metaserver/static/js/modules/core/langpack","metaserver/static/js/modules/constants/files_spa","metaserver/static/js/modules/constants/env","metaserver/static/js/modules/constants/viewer","metaserver/static/js/modules/constants/auth","./c_core_xhr","./c_csrf","./c_browser_cookies","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/ajax_strings","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/webtiming","metaserver/static/js/modules/constants/campaigns_orchestration","metaserver/static/js/modules/constants/maestro_nav_strings","metaserver/static/js/modules/constants/trademark","metaserver/static/js/modules/constants/search","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/undo_strings","./c_typeahead_index","./c_contacts_data_v2","./c_contacts_bloodhound","metaserver/static/js/modules/constants/contacts","./c_profile_services_profile_services_link","./c_profile_services_profile_services_constants","metaserver/static/js/modules/constants/login_and_register"],(function(e,t,a,s,n,i,o,r,c,l,m,d,u,g,_,h,v,f,p,M,b,k,$,R,C,E,y,S,w,j,T,I,x,A,D,F,N,q,L,B,U,W){"use strict";class V{constructor(){this.inFlight=!0,this.canInvite=!1,this.reason="checking",this.callbacks=[]}whenReady(e){this.inFlight?this.callbacks.push(e):e()}resultArrived(e,t){if(this.inFlight){this.inFlight=!1,this.canInvite=e,this.reason=t;for(const e of this.callbacks)e();this.callbacks=[]}}}class z{constructor(e){this.checkEmails=(e,t)=>{const a={};let n=e.length;if(0===n)return t(a);const i=[];for(const s of e){let e=this.checkedEmails[s];e||(e=this.checkedEmails[s]=new V,i.push(s)),e.whenReady((function(){a[s]=e,0==--n&&t(a)}))}i.length>0&&(e=>{s.WebRequest({url:this.checkUrl,data:{emails:e.join(",")},subject_user:s.mustGetActiveUserId(),success:e=>{const t=JSON.parse(e);for(const e in t)if(t[e]){const{can_invite:a,reason:s}=t[e];this.checkedEmails[e]&&this.checkedEmails[e].resultArrived(a,s)}},error:()=>{for(const t of e)delete this.checkedEmails[t]}})})(i)},this.checkUrl=e,this.checkedEmails={}}getEmailCheckResult(e){return this.checkedEmails[e]}}const O=s.Viewer.get_viewer();function G({open:e,onClose:r,user:c,numAvailableLicenses:l,source:m,membersSendInviteDomainRestrictionEnabled:d=!1,teamBusinessDomains:u=[],isSuggestionMode:g,prepopulatedEmails:_=[]}){const[h,v]=t.React$1.useState(!1),[f,p]=t.React$1.useState(null),[M,b]=t.React$1.useState([]),[k,$]=t.React$1.useState(!1),R=t.React$1.useMemo((()=>new z("/team/manage/check_can_invite")),[]),[C,E]=t.React$1.useState(),[y,S]=t.React$1.useState(),[w,j]=t.React$1.useState(_?_.map((e=>s.Contact.buildFromRawEmail(e))):[]),[T,I]=t.React$1.useState(w),[x,A]=t.React$1.useState(""),D=d&&u.length>0,F=D?u:null;if(!g&&void 0===l)throw new Error("numAvailableLicenses is required in invite mode");const N=t.React$1.useCallback((e=>!(e.type!==s.ContactTypes.EMAIL||e.team||!e.name||e.email===c.email)),[c]),q=t.React$1.useCallback((()=>{const e=[i.ContactTokenState.ok,i.ContactTokenState.warn];return 0===T.length||T.every((t=>e.includes(J(t,R,F).state)))}),[F,R,T]),L=t.React$1.useCallback(((e,t)=>{const a=e.filter((e=>e.type===s.ContactTypes.EMAIL&&!e.invalid&&!e.on_team)),n=a.map((e=>e.email));R.checkEmails(n,(()=>{t(a)}))}),[R]),B=t.React$1.useCallback((e=>{L(T,(t=>{const a=t.map((e=>e.email));e({emails:a})}))}),[L,T]),U=t.React$1.useCallback((()=>{h||B((({emails:e})=>{if(!q())return;const t=e=>{j([]),r(e)};v(!0),g?function(e,t,i,o){s.WebRequest({url:"/team/manage/suggest-members",data:{emails:e,url:s.get_href(),source:i},subject_user:s.mustGetActiveUserId(),complete:()=>o(!1),success:()=>(n.Notify.success(a.intl.formatMessage({id:"lMqVLz",defaultMessage:"{num_suggested, plural, one {Thanks for your suggestion! We’ve sent it to the team admin.} other {Thanks for your suggestions! We’ve sent them to the team admin.}}"},{num_suggested:e.length})),t())})}(e,t,m,v):function(e,t,i,o,r,c,l){s.TeamsWebActionsLogger.log("invite_member_open_invite_click",{source:o,member_invite_on:!0,invite_count:e.length});const m={emails:e,team_id:O.team_id,invite_source:s.InviteSource.MEMBER_INVITE,poll_events_on_commit:!1,extra:JSON.stringify({member_send_invite_experiment_enabled:!0,origin:o})},d=Array.isArray(e);t<(d?e.length:1)&&(m.charge_for_new_licenses=!0);s.WebRequest({url:"/account/team/add_users",subject_user:O.work_user,data:m,complete:()=>r(!1),success:t=>{t=JSON.parse(t);const s=Object.values(t.users),o=t.num_suggested||0;if(s.length>0||o>0){if(0!==o)return o>0&&s.length>0?(n.Notify.success(`${a.intl.formatMessage({id:"SX0gpY",defaultMessage:"{num_invites, plural, one {Invited # person} other {Invited # people}}."},{num_invites:s.length})} ${a.intl.formatMessage({id:"lbndFp",defaultMessage:"{num_suggested, plural, one {# invite sent to admin} other {# invites sent to admin}}."},{num_suggested:o})}`),l(e.filter((e=>!s.map((e=>e.email)).includes(e)))),c({num_invited:s.length,invitedUsers:s})):(l(e),c({num_invited:0}));n.Notify.success(a.intl.formatMessage({id:"axSi6e",defaultMessage:"{num_invited, plural, one {Invited.} other {Invited # people.}}"},{num_invited:s.length}))}else n.Notify.error(a.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."}));return i({num_invited:s.length,invitedUsers:s})},error:e=>("rate-limit"===e.getResponseHeader("x-dropbox-app-error")?n.Notify.error(new n.HTML(a.intl.formatMessage({id:"hQ0rRo",defaultMessage:"{team_name} has reached the maximum number of team members allowed on Dropbox Basic. Please <a>contact sales</a> to add more members to your team."},{team_name:O.team_name,a:e=>`<a href="/business/contact">${e}</a>`}))):(s.TeamsWebActionsLogger.log("invite_member_open_invite_error",{source:o,member_invite_on:!0,client:!0}),n.Notify.error(a.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."}))),i({num_invited:0}))})}(e,l,t,m,v,p,b)}))}),[q,B,g,l,r,m,h]),W=t.React$1.useCallback((e=>{let t,a,s=!0;for(const n of e){const{state:e,msg:o}=J(n,R,F);e!==i.ContactTokenState.ok&&(e===i.ContactTokenState.warn?a=null!=a?a:o:(t=null!=t?t:o,s=!1))}S(a),E(t),$(s)}),[F,R]),V=t.React$1.useCallback((e=>{I(e),L(e,(()=>{W(e)}))}),[L,W]),G=t.React$1.useCallback((e=>J(e,R,F)),[F,R]);if(f){const n=()=>{j([]),p(null),b([]),E(void 0),S(void 0),r(f)};return t.React$1.createElement(s.Modal$1,{open:e,withCloseButton:a.intl.formatMessage({id:"a2rDhR",defaultMessage:"Close"}),onRequestClose:n,className:"suggestion-fallback-modal"},t.React$1.createElement(s.Modal$1.Header,{hasBottomSpacing:"title-standard"},t.React$1.createElement(s.Title,null,a.intl.formatMessage({id:"qn5twm",defaultMessage:"Member requests were sent to the admin"}))),t.React$1.createElement(s.Modal$1.Body,{hasVerticalSpacing:!1},t.React$1.createElement("ul",null,M.map((e=>t.React$1.createElement("li",{key:e},e))))),t.React$1.createElement(s.Modal$1.Footer,null,t.React$1.createElement(s.Button$1,{variant:"primary",onClick:n},a.intl.formatMessage({id:"MNcs5F",defaultMessage:"Got it"}))))}const H=()=>{h||(E(void 0),S(void 0),j([]),r())},P=u.map((e=>`@${e}`)),Q=a.intl.formatMessage({id:"GoJlu1",defaultMessage:"name"});let Y="";if(D)switch(P.length){case 1:Y=a.intl.formatMessage({id:"m6/l0s",defaultMessage:"Add any email that ends in {oneDomain}"},{oneDomain:P[0]});break;case 2:Y=a.intl.formatMessage({id:"xw8mQ6",defaultMessage:"Add any email that ends in {firstDomain} or {secondDomain}"},{firstDomain:P[0],secondDomain:P[1]});break;default:Y=a.intl.formatMessage({id:"7aBsbD",defaultMessage:"Add any email that ends in {headDomains} or {lastDomain}"},{headDomains:P.slice(0,P.length-1).join(", ")+",",lastDomain:P[P.length-1]})}function X(e,a){const n="invite-validation-message";let i=n,o=s.FailLine;switch(e){case"warn":o=s.WarningLine,i=s.cx(i,`${n}__non-admin-invite-modal-warn-extensions`);break;case"error":i=s.cx(i,`${n}__non-admin-invite-modal-error-extensions`)}return t.React$1.createElement("div",{className:i},t.React$1.createElement(s.UIIcon,{size:"small",src:o,className:`${n}__icon`}),t.React$1.createElement(s.Text,{size:"small",color:"inherit"},a))}return t.React$1.createElement(a.Provider,{value:a.intl},t.React$1.createElement(s.Modal$1,{open:e,withCloseButton:a.intl.formatMessage({id:"62wFTu",defaultMessage:"Cancel"}),onRequestClose:H,className:"non-admin-invite-modal"},t.React$1.createElement(s.Modal$1.Header,{hasBottomSpacing:"title-standard"},t.React$1.createElement(s.Title,null,g?a.intl.formatMessage({id:"YF+G2c",defaultMessage:"Request Invite"}):a.intl.formatMessage({id:"veD/Im",defaultMessage:"Invite people to {team_name}"},{team_name:O.team_name}))),t.React$1.createElement(s.Modal$1.Body,{hasVerticalSpacing:!1},D&&t.React$1.createElement("div",{className:"non-admin-invite-modal-team-business-domains"},Y),t.React$1.createElement(o.ContactsTokenizerV2,{user:c,placeholder:P.length>0?P.map((e=>`${Q}${e}`)).join(", "):a.intl.formatMessage({id:"w5JCcS",defaultMessage:"Add an email"}),onContentsChange:V,onQueryChange:A,focusOnMount:!0,initialContacts:w,contactValidator:G,contactFilter:N,disabled:h}),C&&X("error",C),y&&X("warn",y)),t.React$1.createElement(s.Modal$1.Footer,null,t.React$1.createElement(s.Button$1,{disabled:h,variant:"opacity",onClick:H,"data-testid":"cancel-button"},a.intl.formatMessage({id:"62wFTu",defaultMessage:"Cancel"})),t.React$1.createElement(s.Button$1,{variant:"primary",disabled:!k||!!x,onClick:U,"data-testid":"submit-button"},h?t.React$1.createElement(s.Spinner,{inverse:!0,size:"small"}):a.intl.formatMessage({id:"rPSCOl",defaultMessage:"Invite to join"})))))}function J(e,t,s){var n;const o=e.email;let r;if(e.invalid)r={state:i.ContactTokenState.invalid,msg:a.intl.formatMessage({id:"iWy49e",defaultMessage:"{email} is not a valid email address."},{email:o})};else if(e.on_team)r={state:i.ContactTokenState.invalid,msg:a.intl.formatMessage({id:"w6S6LE",defaultMessage:"User is already a member of this team."})};else{const e=t.getEmailCheckResult(o);let c;if(e)if(e.inFlight)r={state:i.ContactTokenState.pending,msg:c};else if(e.canInvite){if(r={state:i.ContactTokenState.ok,msg:c},s){const e=null===(n=o.match(/@(.*)$/))||void 0===n?void 0:n[1];e&&!s.includes(e)&&(r={state:i.ContactTokenState.warn,msg:a.intl.formatMessage({id:"LuEFa+",defaultMessage:"Only approved emails are automatically approved"})})}}else"team_member"===e.reason?c=a.intl.formatMessage({id:"/bTRGP",defaultMessage:"This person is already on another team."}):"already_on_this_team"===e.reason?c=a.intl.formatMessage({id:"gUZ177",defaultMessage:"User is already invited to this team."}):"error"===e.reason&&(c=a.intl.formatMessage({id:"I1RVgD",defaultMessage:"User isn’t eligible to join this team."})),r={state:i.ContactTokenState.invalid,msg:c};else r={state:i.ContactTokenState.invalid,msg:c}}return r}const H=s.requireCssWithComponent(G,["/static/metaserver/static/css/react/contacts_tokenizer-vflR-o-P-.css","/static/metaserver/static/css/teams/let_members_invite-vfllwVROJ.css"]);e.MemberInviteModal=G,e.MemberInviteModalWithCSS=H}));
//# sourceMappingURL=c_teams_let_members_invite_non_admin_invite_modal.js-vflQ8qb44.map
