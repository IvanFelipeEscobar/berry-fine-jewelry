define(["require","exports","./e_ui_page_files_router","./c_tslib","./e_edison","./c_src_preview-photo-editor_exif","./c_file_store_utils","./c_src_sink_index","./c_apex-metrics_src_types","./e_core_exception","./c_pap-events_previews_crop_rotate_select_rotate","./c_loggers_device_type","./c_core_exception_info"],(function(e,t,o,r,i,a,n,c,s,l,_,p,v){"use strict";var u;!function(e){e.SET_FILE="SET_FILE",e.SET_UPLOADED_PREVIEW_FILE="SET_UPLOADED_PREVIEW_FILE",e.UPDATE_PREVIEW_DATA="UPDATE_PREVIEW_DATA",e.SET_UPLOADED_FILE_REVISION_ID="SET_UPLOADED_FILE_REVISION_ID",e.SET_CURRENT_FILE="SET_CURRENT_FILE",e.SET_UPDATED_FILE="SET_UPDATED_FILE"}(u||(u={}));const d={};function E(e=d,t){switch(t.type){case u.SET_FILE:return((e,{payload:{file:t}})=>Object.assign(Object.assign({},e),{file:t}))(e,t);case u.UPDATE_PREVIEW_DATA:return((e,{payload:{previewData:t}})=>Object.assign(Object.assign({},e),{previewData:t}))(e,t);case u.SET_CURRENT_FILE:return((e,{payload:{currentFile:t}})=>Object.assign(Object.assign({},e),{currentFile:t}))(e,t);case u.SET_UPDATED_FILE:return((e,{payload:{newRevisionId:t,newPreviewFile:o}})=>{if(o&&o.file.sj_id&&o.file.file_id&&o.preview&&t){const r={file_id:o.file.file_id,revision_id:t,sjid:o.file.sj_id,preview:Object.assign({},o.preview)};return Object.assign(Object.assign({},e),{updatedFile:r})}return e})(e,t);default:return e}}let h;const g=()=>(h||(h=o.getStoreAndRegisterReducers({[o.PREVIEW_CROP_ROTATE_KEY]:E})),h),f=e=>o.getStateAtNamespace(e,o.PREVIEW_CROP_ROTATE_KEY),w=e=>f(e).previewData;function R(e){return{type:u.UPDATE_PREVIEW_DATA,payload:{previewData:e}}}class C{constructor(e){this.category="previews-crop_rotate_activity",this.user_id=null,this.team_id=null,this.session_id=null,this.anon_ip=null,this.country=null,this.url=null,this.ua_browser_name=null,this.ua_browser_version=null,this.locale_user_selected=null,this.timestamp=e.timestamp,this.event_name=e.event_name,this.event_action=e.event_action,this.event_object=e.event_object,this.action_surface=e.action_surface,this.platform="web",this.device_type=e.device_type,this.browser_lang=e.browser_lang,this.browser_width=e.browser_width,this.browser_height=e.browser_height,this.device_width=e.device_width,this.device_height=e.device_height,this.extras=e.extras,Object.seal(this)}}function b(e){return{class:"previews_crop_rotate",action:"select",object:"save",properties:e}}var T,m;t.CropRotateEvent=void 0,(T=t.CropRotateEvent||(t.CropRotateEvent={})).shownCropRotateOptions="shown_crop_rotate_options",T.selectRotate="select_rotate",T.selectCrop="select_crop",T.selectSaveFromCrop="select_save_from_crop",T.selectReplaceOriginalButton="select_replace_original_button",T.selectMakeACopy="select_make_a_copy",T.selectSaveFromMakeACopy="select_save_from_make_a_copy",T.shownErrorEvent="shown_error_event",function(e){e.fileViewerToolbar="file_viewer_toolbar",e.cropToolbar="crop_toolbar",e.makeACopyModal="make_a_copy_modal"}(m||(m={}));const I={[t.CropRotateEvent.selectRotate]:["loadingTime"],[t.CropRotateEvent.selectCrop]:["loadingTime"],[t.CropRotateEvent.selectReplaceOriginalButton]:["loadingTime","cropHeight","cropWidth"],[t.CropRotateEvent.selectSaveFromMakeACopy]:["loadingTime","cropHeight","cropWidth"]};function y(e,r,i){const a=Object.assign(Object.assign({timestamp:Date.now(),event_name:e},function(e){switch(e){case t.CropRotateEvent.shownCropRotateOptions:return{event_action:"shown",event_object:"crop_rotate_options",action_surface:m.fileViewerToolbar};case t.CropRotateEvent.selectRotate:return{event_action:"select",event_object:"rotate",action_surface:m.fileViewerToolbar};case t.CropRotateEvent.selectCrop:return{event_action:"select",event_object:"crop",action_surface:m.fileViewerToolbar};case t.CropRotateEvent.selectSaveFromCrop:return{event_action:"select",event_object:"save",action_surface:m.cropToolbar};case t.CropRotateEvent.selectReplaceOriginalButton:return{event_action:"select",event_object:"replace_original_button",action_surface:m.cropToolbar};case t.CropRotateEvent.selectMakeACopy:return{event_action:"select",event_object:"make_a_copy",action_surface:m.cropToolbar};case t.CropRotateEvent.selectSaveFromMakeACopy:return{event_action:"select",event_object:"save",action_surface:m.makeACopyModal};case t.CropRotateEvent.shownErrorEvent:return{event_action:"shown",event_object:"error_event",action_surface:""};default:o.enforceExhaustive(e)}}(e)),{device_type:p.getDeviceType(),browser_lang:window.navigator.language,browser_width:window.innerWidth,browser_height:window.innerHeight,device_width:window.screen.width,device_height:window.screen.height});if(r&&function(e){return e in I}(e)){a.extras={};for(const t of I[e]){const e=r[t];"string"==typeof e&&(a.extras[t]=e)}}var n;A.log(new C(a)),function(e,r){let i;switch(e){case t.CropRotateEvent.shownCropRotateOptions:o.logEvent({class:"previews_crop_rotate",action:"shown",object:"crop_rotate_options",properties:{actionSurface:m.fileViewerToolbar}});break;case t.CropRotateEvent.selectRotate:o.logEvent(_.PAP_Select_Rotate({actionSurface:m.fileViewerToolbar,loadingTime:parseInt((null==r?void 0:r.loadingTime)||"",10)}));break;case t.CropRotateEvent.selectCrop:o.logEvent(_.PAP_Select_Crop({actionSurface:m.fileViewerToolbar,loadingTime:parseInt((null==r?void 0:r.loadingTime)||"",10)}));break;case t.CropRotateEvent.selectSaveFromCrop:o.logEvent(b({actionSurface:m.cropToolbar}));break;case t.CropRotateEvent.selectReplaceOriginalButton:i=r,o.logEvent(function(e){return{class:"previews_crop_rotate",action:"select",object:"replace_original_button",properties:e}}({actionSurface:m.cropToolbar,loadingTime:parseInt((null==i?void 0:i.loadingTime)||"",10),cropHeight:parseInt((null==i?void 0:i.cropHeight)||"",10),cropWidth:parseInt((null==i?void 0:i.cropWidth)||"",10)}));break;case t.CropRotateEvent.selectMakeACopy:o.logEvent(function(e){return{class:"previews_crop_rotate",action:"select",object:"make_a_copy",properties:e}}({actionSurface:m.cropToolbar}));break;case t.CropRotateEvent.selectSaveFromMakeACopy:i=r,o.logEvent(b({actionSurface:m.makeACopyModal,loadingTime:parseInt((null==i?void 0:i.loadingTime)||"",10),cropHeight:parseInt((null==i?void 0:i.cropHeight)||"",10),cropWidth:parseInt((null==i?void 0:i.cropWidth)||"",10)}));break;case t.CropRotateEvent.shownErrorEvent:o.logEvent(function(e){return{class:"previews_crop_rotate",action:"shown",object:"error_event",properties:e}}());break;default:o.enforceExhaustive(e)}}(e,a.extras),e===t.CropRotateEvent.shownErrorEvent&&(n={metricName:t.AmpMetrics.ERROR},c.getMetricsReporter().createStats({ns:P,name:n.metricName},n.metricTags).record(1),i&&function(e){let t;t=e.extra?[...F,...e.extra]:[...F];l.reportException({err:e.error,tags:[...D],severity:e.severity,exc_extra:t,force:!0})}({error:i,severity:v.SEVERITY.NON_CRITICAL}))}const A=new o.HiveLogger;const P="previews_crop_rotate";var S;t.AmpMetrics=void 0,(S=t.AmpMetrics||(t.AmpMetrics={})).ERROR="crop_rotate/error",S.ROTATION_SAVE_LATENCY="crop_rotate/rotation_save_latency";const D=["previews_crop_rotate"],F=["Previews Crop Rotate"];const O=Object.freeze({logCropRotateEvent:()=>{}}),j=i.reactExports.createContext(O),x=j.Provider;class L{constructor(e,t,r,a,c,s){this.identifier="imageCropRotate",this.lifecycle={previewDidInitialize:e=>{const{file:t,previewData:o}=this.context.getPluginData();t&&"dimensions"in t&&this.store.dispatch(function(e){return{type:u.SET_FILE,payload:{file:e}}}(t)),o&&this.store.dispatch(R(o))}},this.toolbarUI=({className:e})=>{const{previewData:t,navigation:r}=this.context.getPluginData(),{file:a}=this.getActiveFile(),c=n.getExtension(a);return i.React$1.createElement(o.Provider,{store:this.store},i.React$1.createElement(x,{value:{logCropRotateEvent:y}},i.React$1.createElement(i.React$1.Suspense,{fallback:i.React$1.createElement("div",null)},i.React$1.createElement(k,{pluginId:this.pluginId,user:this.user,className:e,onImageChanged:this.onFileChanged,hideContentPane:r.hideContentPane,context:this.context,getActiveFile:this.getActiveFile,updatePreviewMetadata:r.updatePreviewMetadata,fileExtension:c,previewData:t}))))},this.user=e,this.context=t,this.store=r,this.pluginId=a,this.getActiveFile=()=>c(),this.onFileChanged=(e,t)=>null==s?void 0:s(e,t)}}const k=i.React$1.lazy((()=>r.__awaiter(void 0,void 0,void 0,(function*(){const{CropRotateButtons:t}=yield new Promise((function(t,o){e(["./c_ui_preview_crop_and_rotate_crop_rotate_buttons"],t,o)}));return{default:t}}))));var M=Object.freeze({__proto__:null,getStoreForCropRotateInPreview:g,getUpdatedFile:e=>f(e).updatedFile,loadCropRotatePlugin:(e,t,o,r,i)=>new L(t,o,g(),e,r,i)});t.crop_rotate_exports_esnext=M,t.getFile=e=>f(e).file,t.getFullSizeImageUrl=e=>{let t;const o=w(e);return o&&o.content&&"full_size_src"in o.content&&(t=o.content.full_size_src),t},t.getPreviewData=w,t.logDuration=function(e,t){c.getMetricsReporter().createStats({ns:P,name:e}).recordDuration(t,s.TimeUnit.MILLISECONDS)},t.setCurrentFile=function(e){return{type:u.SET_CURRENT_FILE,payload:{currentFile:e}}},t.updatePreviewData=R,t.uploadCopyImage=function(e,t,o,i,n){return()=>r.__awaiter(this,void 0,void 0,(function*(){if(e){const r=yield a.toArrayBuffer(t);try{yield a.saveCopy(e,o,r,i)}catch(e){n(e)}}}))},t.uploadImage=function(e,t,i,n,c,s){return(l,_)=>r.__awaiter(this,void 0,void 0,(function*(){const r=_()[o.PREVIEW_CROP_ROTATE_KEY];if(e){const o=yield a.toArrayBuffer(t);let _,p;try{_=yield a.saveReplace(e.file_id,i,o,n)}catch(e){s(e)}_&&"rev"in _&&(p=_.rev);const v=(yield a.getPreviewMetadata(i,e.file_id)).results[0];p&&l(function(e,t){return{type:u.SET_UPDATED_FILE,payload:{newRevisionId:e,newPreviewFile:t}}}(p,v)),c(v,p,null==r?void 0:r.currentFile)}}))},t.useCropRotateLogger=function(){const{logCropRotateEvent:e}=i.reactExports.useContext(j);return e}}));
//# sourceMappingURL=c_ui_preview_crop_and_rotate_crop_rotate_exports.js-vflFHevGo.map
