define(["exports","./c_tslib","./c_lodash-es_lodash","./e_ui_page_files_router","./c_file_store_utils"],(function(e,t,r,i,n){"use strict";var s;e.ActionTypes=void 0,(e.ActionTypes||(e.ActionTypes={})).UpdatePreviewData="FileViewer/Previews/UpdatePreviewData",function(e){e.Fetch="Fetch",e.Request="Request",e.Success="Success",e.Error="Error"}(s||(s={}));const o={data:void 0,status:s.Error};function a(e,t){const r=function(e){return i.getStateAtNamespace(e,i.PREVIEW_NAMESPACE_KEY)}(e);if(!r||!t)return o;const s=n.getFileRevisionId(t),a=r.filePreviews[s];return a&&a.status?a:o}function u(e,t){return t.reduce(((t,r)=>(t[n.getFileRevisionId(r)]=a(e,r),t)),{})}function c(e,t,r=!1){if(!t)return Promise.reject(new Error("user not logged in, no support for un-auth'd users yet"));const n={files:e.map((e=>({ns_id:e.ns_id,sj_id:e.sjid}))),include_dimensions:r};return t?(new i.UserApiV2Client).ns("previews").rpc("get_preview_data_batch",n,{subjectUserId:t.id}):(new i.NoAuthApiV2Client).ns("previews").rpc("get_preview_data_batch",n,{})}function d(t){const r={};return t.forEach((e=>{const t=n.getFileRevisionId(e),i=e.preview;i&&(r[t]={data:i,status:s.Success})})),{type:e.ActionTypes.UpdatePreviewData,payload:r}}function l(e,i,o,a){return(d,l)=>t.__awaiter(this,void 0,void 0,(function*(){const p=function(e,t,i=!1){if(i)return t;const o=u(e,t);return r.filter(t,(e=>{const t=n.getFileRevisionId(e);return!e.is_dir&&(!o[t]||!o[t].data&&o[t].status===s.Error)}))}(l(),e,o);if(0===p.length)return;const w=function(e,t){if(e.length<=0)return[];if(e.length<t)return[e];const r=Array(Math.ceil(e.length/t));let i=0,n=0;for(;i<e.length;)r[n++]=e.slice(i,i+=t);return r}(p,50),h=w.map((e=>function(e,r,i,o){return t.__awaiter(this,void 0,void 0,(function*(){const t=function(e){return e.reduce(((e,t)=>(e[n.getFileRevisionId(t)]={data:void 0,status:s.Request},e)),{})}(r);e(f(t));try{const n=yield c(r,i,o);return e(v(Object.keys(t),n))}catch(r){return e(_(t))}}))}(d,e,i,a)));return Promise.all(h)}))}function p(t){return{type:e.ActionTypes.UpdatePreviewData,payload:t}}const f=p;function v(t,r){const i=r.results.reduce(((e,t)=>(e[n.getFileRevisionId({ns_id:t.file.ns_id,sjid:t.file.sj_id})]=t,e)),{});return{type:e.ActionTypes.UpdatePreviewData,payload:t.reduce(((e,t)=>{const r=i[t],n={data:null==r?void 0:r.preview,status:s.Success};return e[t]=n,e}),{})}}function _(t){return{type:e.ActionTypes.UpdatePreviewData,payload:r.mapValues(t,(e=>({data:void 0,status:s.Error})))}}var w=Object.freeze({__proto__:null,apiRequestErrorAction:_,apiRequestInFlightAction:f,apiRequestSuccessAction:v,fetchPreviewData:l,fetchPreviewUrl:function(e,t){return c([e],t).then((e=>{if(e.results.length>0){const t=e.results[0].preview;if(t&&t.preview_url)return t.preview_url}}))},populateFilesPreviewData:d,updatePreviewData:p});e.actions_esnext=w,e.fetchPreviewData=l,e.getApiDataForFiles=u,e.populateFilesPreviewData=d,e.previewDataInFlight=function(e,t){return function(e,t){const r=a(e,t);return r?r.status:void 0}(e,t)===s.Request},e.previewDataPresentForFile=function(e,t){const r=a(e,t);return!(!r||!r.data||r.status===s.Error)}}));
//# sourceMappingURL=c_previews_data_actions.js-vflFz4Zrc.map
